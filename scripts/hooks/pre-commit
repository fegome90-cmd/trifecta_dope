#!/bin/bash
# pre-commit hook - Trifecta fail-closed gates
# Blocks bypass, validates WO, syncs context

set -euo pipefail

if [[ "${TRIFECTA_HOOKS_DISABLE:-0}" == "1" ]]; then
    echo "ℹ️  TRIFECTA_HOOKS_DISABLE=1, skipping hooks"
    exit 0
fi

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")
cd "$REPO_ROOT"

echo "[hooks] pre-commit starting..."

# 1) Block manual WO closure
echo "[hooks] Checking for manual WO closure..."
bash scripts/hooks/prevent_manual_wo_closure.sh

# 2) Format + lint WO YAMLs if touched
echo "[hooks] Checking WO YAML changes..."
bash scripts/hooks/wo_fmt_lint.sh

# 3) Integrity check
echo "[hooks] Running integrity check..."
uv run python scripts/hooks/trifecta_integrity_check.py

# 4) Optional test gate
if [[ -n "${TRIFECTA_PRECOMMIT_TEST_CMD:-}" ]]; then
    echo "[hooks] Running test gate..."
    bash scripts/hooks/pre_commit_test_gate.sh
fi

# 5) Context sync
echo "[hooks] Syncing context..."
if command -v uv &>/dev/null; then
    uv run trifecta ctx sync --segment . || {
        echo "❌ Context pack sync failed"
        exit 1
    }
    git add _ctx/context_pack.json 2>/dev/null || true
    echo "✅ Context synced"
fi

echo "[hooks] pre-commit PASS"
exit 0
