#!/bin/bash
# pre-commit hook - Documentation validation
# Validates docs and syncs context before commit

set -euo pipefail

# Optional kill-switch
if [[ "${TRIFECTA_HOOKS_DISABLE:-0}" == "1" ]]; then
    echo "â„¹ï¸  TRIFECTA_HOOKS_DISABLE=1, skipping hooks"
    exit 0
fi

# Check for doc changes (only relevant files)
CHANGED_FILES=$(git diff --cached --name-only 2>/dev/null || true)

# Determine if we should run
DOC_FILES_PATTERN="CLAUDE.md|agents.md|skill.md|llms.txt|docs/|skills/documentation/|\.documentation-skill"
if ! echo "$CHANGED_FILES" | grep -qE "$DOC_FILES_PATTERN"; then
    echo "â„¹ï¸  No documentation changes detected, skipping doc validation"
    exit 0
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ Documentation Validation Hook"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Find root (hand repoles worktrees)
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")

# STEP 1: Validate documentation patterns
echo ""
echo "1ï¸âƒ£  Validating documentation patterns..."
if bash "$REPO_ROOT/skills/documentation/resources/verify_documentation.sh" "$REPO_ROOT"; then
    echo "âœ… Documentation validation passed"
else
    echo "âŒ Documentation validation failed!"
    echo ""
    echo "Fix issues and retry, or bypass with:"
    echo "  git commit --no-verify"
    exit 1
fi

# STEP 2: Sync context (only if doc changes)
echo ""
echo "2ï¸âƒ£  Syncing context pack..."
if command -v uv &>/dev/null; then
    if uv run trifecta ctx sync --segment "$REPO_ROOT" >/dev/null 2>&1; then
        echo "âœ… Context pack synced"
    else
        echo "âš ï¸  ctx sync had issues (non-blocking, check _ctx/ manually)"
    fi
else
    echo "âš ï¸  uv not found, skipping ctx sync"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Documentation validated and synced!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

exit 0
