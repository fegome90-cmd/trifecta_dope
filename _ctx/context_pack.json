{
  "schema_version": 1,
  "segment": "trifecta_dope",
  "created_at": "2025-12-30T22:41:07.568828",
  "digest": "",
  "source_files": [
    {
      "path": "skill.md",
      "sha256": "5055bae97e8a61acc0e335435cd90241767fdb26dc7d141333647246a554718d",
      "mtime": 1767099226.406185,
      "chars": 3541
    },
    {
      "path": "_ctx/agent.md",
      "sha256": "327bb2a8d558b5748d5fd5a77297af24cdb92d9872d1e8c07f0757ccad5ffa73",
      "mtime": 1767099581.0761712,
      "chars": 2905
    },
    {
      "path": "_ctx/prime_trifecta_dope.md",
      "sha256": "22d51dbd425954a3b0945a8fefcb8551c9b366b65d9c5e1f7fe17e0e64f81f6a",
      "mtime": 1767099226.402185,
      "chars": 1383
    },
    {
      "path": "_ctx/session_trifecta_dope.md",
      "sha256": "3cf6f3295a02d5b960e48913c87750353d99ef1e2cb3cab3287a3caaedbe2791",
      "mtime": 1767134388.8794916,
      "chars": 8189
    },
    {
      "path": "README.md",
      "sha256": "4117bdab2f3327d9f619cebb38452dc87ec24ab881c12910eb3f15efeb3f59d1",
      "mtime": 1767116928.7021475,
      "chars": 12707
    },
    {
      "path": "RELEASE_NOTES_v1.md",
      "sha256": "81ddd6f56a6b40293cedee9e63be9218162c0fff7fdc220c0be563b0fa9482b6",
      "mtime": 1767099226.402185,
      "chars": 1696
    }
  ],
  "chunks": [
    {
      "id": "skill:773705da1d",
      "doc": "skill",
      "title_path": [
        "skill.md"
      ],
      "text": "---\nname: trifecta_dope\ndescription: Use when working on Verification\n---\n## Overview\nVerification\n\n**UbicaciÃ³n**: `/Users/felipe_gonzalez/Developer/agent_h/trifecta_dope/`\n\n## âš ï¸ ONBOARDING OBLIGATORIO âš ï¸\n\n1. **skill.md** (este archivo) - Reglas y roles\n2. **[PRIME](./_ctx/prime_trifecta_dope.md)** - Docs obligatorios\n3. **[AGENT](./_ctx/agent.md)** - Stack tÃ©cnico y gates\n4. **[SESSION](./_ctx/session_trifecta_dope.md)** - Log de handoffs y estado actual\n\n> NO ejecutes cÃ³digo ni hagas cambios sin leer los 4 archivos.\n\n## Core Rules\n1. **Sync First**: Valida `.env` antes de cambios\n2. **Test Locally**: Tests del segmento antes de commit\n3. **Read Before Write**: Lee cÃ³digo antes de modificar\n4. **Document**: Actualiza `session_..md`\n\n### CRITICAL PROTOCOL: Session Evidence Persistence (Trifecta)\n\nAntes de ejecutar cualquier herramienta (Trifecta CLI o agentes externos), DEBES seguir este orden. NO tomes atajos.\n\n1) PERSISTE intencion minima (CLI proactivo - NO depende del LLM):\n```bash\ntrifecta session append --segment . --summary \"<que vas a hacer>\" --files \"<csv>\" --commands \"<csv>\"\n```\n\n2) SYNC del segmento\n```bash\ntrifecta ctx sync --segment .\n```\n\n3) LEE lo que acabas de escribir (confirma Objective/Plan registrado en session.md)\n\n4) EJECUTA el ciclo de contexto (Plan A por defecto)\n```bash\ntrifecta ctx search --segment . --query \"<tema>\" --limit 6\ntrifecta ctx get --segment . --ids \"<id1>,<id2>\" --mode excerpt --budget-token-est 900\n```\n\n5) REGISTRA resultado (CLI proactivo):\n```bash\ntrifecta session append --segment . --summary \"Completed <task>\" --files \"<touched>\" --commands \"<executed>\"\n```\n\nSTALE FAIL-CLOSED PROTOCOL (CRITICAL):\n- Si `ctx validate` falla o `stale_detected=true` -> STOP inmediatamente\n- Ejecutar: `trifecta ctx sync --segment .` + `trifecta ctx validate --segment .`\n- Registrar en session.md: \"Stale: true -> sync+validate executed\"\n- Prohibido continuar hasta PASS\n\nProhibido:\n- YAML de historial largo\n- rutas absolutas fuera del segmento\n- ejecutar scripts legacy de ingestion\n- \"fallback silencioso\"\n- continuar con pack stale\n\n## When to Use\n\n- Cuando necesites sincronizar o validar el contexto de un segmento.\n- Al realizar un handoff entre sesiones (registrar en `session.md`).\n- Para buscar informaciÃ³n especÃ­fica en el pack de contexto sin cargar archivos completos.\n\n## Core Pattern\n\n### The Context Cycle (Search -> Get)\n1. **Search**: Encuentra el `chunk_id` relevante.\n2. **Get (Excerpt)**: Lee un resumen/inicio para confirmar relevancia.\n3. **Get (Raw)**: Carga el contenido completo solo si es necesario y cabe en el presupuesto.\n\n### Session Persistence\n\n> [!IMPORTANT]\n> **Todo** cambio significativo o comando ejecutado **DEBE** ser registrado en `session.md` para mantener la continuidad del agente. Sin esto, el sistema Trifecta es solo un CLI; la persistencia es lo que permite la colaboraciÃ³n multi-agente funcional.\n\n## Common Mistakes\n\n- **Indexar cÃ³digo**: El pack es para DOCS (`.md`). El cÃ³digo se accede vÃ­a prime links.\n- **Ignorar validaciones**: Continuar si `ctx validate` falla es una violaciÃ³n crÃ­tica.\n- **Presupuesto excedido**: Intentar cargar mÃ¡s de 1200 tokens en un solo turno degrada la atenciÃ³n del agente.\n- **Rutas absolutas**: Siempre usa rutas relativas al segmento o al repo root.\n\n## Resources (On-Demand)\n- `@_ctx/prime_trifecta_dope.md` - Lista de lectura obligatoria\n- `@_ctx/agent.md` - Stack tÃ©cnico y gates\n- `@_ctx/session_trifecta_dope.md` - Log de handoffs (runtime)\n\n---\n**Profile**: `impl_patch` | **Updated**: 2025-12-29\n",
      "char_count": 3541,
      "token_est": 885,
      "source_path": "skill.md",
      "chunking_method": "whole_file"
    },
    {
      "id": "agent:39151e4814",
      "doc": "agent",
      "title_path": [
        "agent.md"
      ],
      "text": "---\nsegment: .\nscope: Verification\nrepo_root: /Users/felipe_gonzalez/Developer/agent_h\nlast_verified: 2025-12-29\ndefault_profile: impl_patch\n---\n\n# Agent Context - .\n\n## Source of Truth\n\n| SecciÃ³n | Fuente |\n|---------|--------|\n| Reglas de SesiÃ³n | [skill.md](../skill.md) |\n| Dependencias | `pyproject.toml` |\n| LÃ³gica Core | `src/domain/` y `src/application/` |\n| Entry Points | `src/infrastructure/cli.py` |\n| EstÃ¡ndar de Docs | `README.md` y `knowledge/` |\n\n## Tech Stack\n\n**Lenguajes:**\n- Python 3.12+ (Backend/CLI)\n- Fish Shell (Completions)\n\n**Frameworks:**\n- Typer (CLI Framework)\n- Pydantic (Data Models/Schema)\n- PyYAML (Artifacts parsing)\n\n**Herramientas:**\n- uv (Project Management)\n- pytest (Testing)\n- ruff (Linting/Formatting)\n- mypy (Static Types)\n\n## Workflow\n```bash\n# SEGMENT=\".\" es vÃ¡lido SOLO si tu cwd es el repo target.\n# Si ejecutas trifecta desde otro lugar, usa un path absoluto:\n# SEGMENT=\"/Users/felipe_gonzalez/Developer/agent_h/trifecta_dope\"\ncd /Users/felipe_gonzalez/Developer/agent_h/trifecta_dope/\n# Validar entorno â†’ Sync context â†’ Ejecutar cambios â†’ Validar gates\n```\n\n## Setup\n\n**Entorno Python (Recomendado):**\n```bash\n# Usando uv (rÃ¡pido y determinÃ­stico)\nuv sync\nsource .venv/bin/activate\n```\n\n**Variables de Entorno (.env):**\n```bash\n# Requerido para telemetrÃ­a y LiteLLM (si aplica)\nTRIFECTA_TELEMETRY_LEVEL=lite\n```\n\n## Gates (Comandos de VerificaciÃ³n)\n\n| Gate | Comando | PropÃ³sito |\n|------|---------|-----------|\n| **Unit** | `uv run pytest tests/unit/ -v` | LÃ³gica interna |\n| **IntegraciÃ³n** | `uv run pytest tests/test_use_cases.py -v` | Flujos CLI/UseCases |\n| **Lint** | `uv run ruff check .` | Calidad de cÃ³digo |\n| **Type** | `uv run mypy src/` | Integridad de tipos |\n| **Context** | `uv run trifecta ctx validate --segment .` | Integridad del pack |\n\n## Troubleshooting\n\n| Problema | SoluciÃ³n |\n|----------|----------|\n| `ImportError` | `uv pip install -e .` desde el root |\n| `.env` faltante | Copiar desde `.env.example` y configurar |\n| Pack Stale | `uv run trifecta ctx sync --segment .` |\n| Fallos en Tests | Revisar logs en `_ctx/telemetry/` |\n\n## Integration Points\n\n**Upstream Dependencies:**\n- `pydantic` - Base de modelos de dominio\n- `typer` - Motor del CLI\n- `pyyaml` - SerializaciÃ³n de estados/config\n\n**Downstream Consumers:**\n- Agentes de cÃ³digo que necesiten contexto estructurado\n- Autopilot pipelines\n\n## Resources (On-Demand)\n- `@_ctx/prime_trifecta_dope.md` - Lista de lectura obligatoria\n- `@_ctx/agent.md` - (Este archivo) Tech stack y gates\n- `@_ctx/session_trifecta_dope.md` - Log de handoffs (runtime)\n- `readme_tf.md` - GuÃ­a rÃ¡pida del sistema\n\n## LLM Roles\n\n| Rol | Modelo | Uso |\n|-----|--------|-----|\n| **Worker** | `deepseek-reasoner` | Tareas generales y razonamiento |\n| **Senior** | `claude-sonnet-4-5` | DiseÃ±o complejo y refactor |\n| **Fallback** | `gemini-3.0-flash-preview` | RecuperaciÃ³n y validaciÃ³n rÃ¡pida |\n",
      "char_count": 2905,
      "token_est": 726,
      "source_path": "agent.md",
      "chunking_method": "whole_file"
    },
    {
      "id": "prime:48de346017",
      "doc": "prime",
      "title_path": [
        "prime_trifecta_dope.md"
      ],
      "text": "---\nsegment: trifecta-dope\nprofile: load_only\n---\n\n# Prime Trifecta Dope - Lista de Lectura\n\n> **REPO_ROOT**: `/Users/felipe_gonzalez/Developer/agent_h/trifecta_dope`\n> Todas las rutas son relativas a esta raiz.\n>\n> **Orden de lectura**: Fundamentos -> Implementacion -> Referencias\n\n## [HIGH] Prioridad ALTA - Fundamentos\n\n**Leer primero para entender el contexto del segmento.**\n\n1. `README.md` - VisiÃ³n general del proyecto y CLI\n2. `skill.md` - Reglas de oro y protocolos de sesiÃ³n\n3. `RELEASE_NOTES_v1.md` - Estado actual y cambios recientes (T7/T8 Hardening)\n\n## [MED] Prioridad MEDIA - Implementacion\n\n<!-- Documentacion de implementacion especifica -->\n<!-- Ejemplos: guias de uso, patrones de disenio -->\n\n## [LOW] Prioridad BAJA - Referencias\n\n<!-- Documentacion de referencia, archivada -->\n<!-- Ejemplos: API docs, especificaciones -->\n\n## [MAP] Mapa Mental\n\n```mermaid\nmindmap\n  root(trifecta-dope)\n    <!-- Agregar conceptos clave del segmento -->\n    <!-- Ejemplo:\n    Fundamentos\n    Arquitectura\n    Componentes\n    Interfaces\n    -->\n```\n\n## [DICT] Glosario\n\n| Termino | Definicion |\n|---------|------------|\n| <!-- Agregar terminos clave del segmento --> | <!-- Definiciones breves --> |\n\n## [NOTE] Notas\n\n- **Fecha ultima actualizacion**: 2025-12-29\n- **Mantenedor**: <!-- Agregar si aplica -->\n- **Ver tambien**: [skill.md](../skill.md) | [agent.md](./agent.md)\n",
      "char_count": 1383,
      "token_est": 345,
      "source_path": "prime_trifecta_dope.md",
      "chunking_method": "whole_file"
    },
    {
      "id": "session:99cac305f7",
      "doc": "session",
      "title_path": [
        "session_trifecta_dope.md"
      ],
      "text": "# session.md - Trifecta Context Runbook\n\nsegment: trifecta-dope\n\n## Purpose\nThis file is a **runbook** for using Trifecta Context tools efficiently:\n- progressive disclosure (search -> get)\n- strict budget/backpressure\n- evidence cited by [chunk_id]\n\n## Quick Commands (CLI)\n```bash\n# SEGMENT=\".\" es valido SOLO si tu cwd es el repo target (el segmento).\n# Si ejecutas trifecta desde otro lugar (p.ej. desde el repo del CLI), usa un path absoluto:\n# SEGMENT=\"/abs/path/to/AST\"\nSEGMENT=\".\"\n\n# Usa un termino que exista en el segmento (ej: nombre de archivo, clase, funcion).\n# Si no hay hits, refina el query o busca por simbolos.\ntrifecta ctx sync --segment \"$SEGMENT\"\ntrifecta ctx search --segment \"$SEGMENT\" --query \"<query>\" --limit 6\ntrifecta ctx get --segment \"$SEGMENT\" --ids \"<id1>,<id2>\" --mode excerpt --budget-token-est 900\ntrifecta ctx validate --segment \"$SEGMENT\"\ntrifecta load --segment \"$SEGMENT\" --mode fullfiles --task \"Explain how symbols are extracted\"\n```\n\n## Rules (must follow)\n\n* Max **1 ctx.search + 1 ctx.get** per user turn.\n* Prefer **mode=excerpt**; use raw only if necessary and within budget.\n* Cite evidence using **[chunk_id]**.\n* If **validate fails**: stop, rebuild. **No silent fallback**.\n* **STALE FAIL-CLOSED**: If `stale_detected=true`, STOP -> `ctx sync` + `ctx validate` -> log \"Stale: true -> sync+validate executed\" -> continue only if PASS.\n\n## Session Log (append-only)\n\n### Entry Template (max 12 lines)\n```md\n## YYYY-MM-DD HH:MM - ctx cycle\n- Segment: .\n- Objective: <que necesitas resolver>\n- Plan: ctx sync -> ctx search -> ctx get (excerpt, budget=900)\n- Commands: (pending/executed)\n- Evidence: (pending/[chunk_id] list)\n- Warnings: (none/<code>)\n- Next: <1 concrete step>\n```\n\nReglas:\n- **append-only** (no reescribir entradas previas)\n- una entrada por run\n- no mas de 12 lineas\n\n## TRIFECTA_SESSION_CONTRACT (NON-EXECUTABLE in v1)\n\n> Documentation only. Not executed automatically in v1.\n\n```yaml\nschema_version: 1\nsegment: .\nautopilot:\n  enabled: false\n  note: \"v2 idea only - NOT executed in v1\"\n```\n\n## Watcher Example (optional)\n\n```bash\n# Ignore _ctx to avoid loops.\nfswatch -o -e \"_ctx/.*\" -i \"skill.md|prime.md|agent.md|session.md\" . \\\n  | while read; do trifecta ctx sync --segment \"$SEGMENT\"; done\n```\n\n## Next User Request\n\n<!-- The next agent starts here -->\n\n## 2025-12-29 23:44 UTC\n- **Summary**: Corrected T9.A to Context Routing Accuracy (not RAG). Updated aliases for routing, created evidence reports.\n- **Files**: implementation_plan.md, t9a_context_routing_accuracy.md, aliases.yaml\n- **Commands**: ctx sync, ctx search, session append\n- **Pack SHA**: `a38f1cacdb4f0afc`\n\n## 2025-12-29 23:49 UTC\n- **Summary**: Demonstrated Trifecta CLI usage: ctx search, ctx get, ctx stats\n- **Files**: skill.md\n- **Commands**: ctx search, ctx get, ctx stats\n- **Pack SHA**: `557f59c5e54ff34c`\n\n## 2025-12-29 23:54 UTC\n- **Summary**: Analyzed scope deviations: T9.A corrected (PCC not RAG), identified pending tasks (trifecta load, MCP, Progressive Disclosure)\n- **Files**: scope_analysis.md\n- **Commands**: mini-rag query, ctx search\n- **Pack SHA**: `557f59c5e54ff34c`\n\n## 2025-12-29 23:58 UTC\n- **Summary**: T9 Correction Evidence Report completed: 7/9 PASS, 1 FAIL (missing prohibition), 1 BELOW (routing 75%)\n- **Files**: t9-correction-evidence.md\n- **Commands**: ctx validate, ctx search, ctx get, pytest\n- **Pack SHA**: `557f59c5e54ff34c`\n\n## 2025-12-30 00:12 UTC\n- **Summary**: Updated prime docs (Paths), agent SOT (Tech Stack/Gates), and synced context pack.\n- **Files**: _ctx/prime_trifecta_dope.md, _ctx/agent.md, _ctx/session_trifecta_dope.md, readme_tf.md\n- **Commands**: ctx sync, session append\n- **Pack SHA**: `c3c0a4a0003f2420`\n\n## 2025-12-30 16:41 UTC\n- **Summary**: MVP Experience Report: Trifecta Performance Analysis (7.2K tokens, 5 queries, 99.9% token precision)\n- **Files**: docs/technical_reports/2025-12-30_trifecta_mvp_experience_report.md\n- **Commands**: ctx build, ctx search (2x), ctx get, session append\n- **Pack SHA**: `8d3f162fcba632d0`\n\n## 2025-12-30 16:52 UTC\n- **Summary**: Generated MVP Experience Report + Session Log update. Plan next: script refactor + deduplication (skill.md). Future: Progressive Disclosure AST/LSP.\n- **Files**: docs/technical_reports/2025-12-30_trifecta_mvp_experience_report.md, docs/technical_reports/SUMMARY_MVP.md\n- **Commands**: ctx sync, session append\n- **Pack SHA**: `9e45196d3636392c`\n\n## 2025-12-30 17:11 UTC\n- **Summary**: PHASE 2 (GREEN) START: Implementing validators.py + REFERENCE_EXCLUSION deduplication fix\n- **Files**: tests/unit/test_validators.py\n- **Commands**: pytest (15 tests RED)\n- **Pack SHA**: `9db6857f8d5d770e`\n\n## 2025-12-30 17:14 UTC\n- **Summary**: PHASE 2 (GREEN) COMPLETE: 15/15 tests PASS, validators.py created, REFERENCE_EXCLUSION added, skill.md deduplicated (7â†’6 chunks, -646 tokens)\n- **Files**: src/infrastructure/validators.py, src/infrastructure/file_system.py, tests/unit/test_validators.py\n- **Commands**: pytest tests/unit/test_validators.py -v (15 PASS), ctx sync, ctx validate (PASS)\n- **Pack SHA**: `97e765d7137fcc3b`\n\n## 2025-12-30 17:43 UTC\n- **Summary**: AUDIT COMPLETE + PHASE 3 (REFACTOR): Path-aware deduplication proven, nested skill.md support validated, imports migrated to src/, 82/82 tests PASS, ruff clean\n- **Files**: src/application/use_cases.py, src/infrastructure/file_system.py, src/infrastructure/validators.py, tests/unit/test_validators.py, tests/installer_test.py, scripts/install_FP.py\n- **Commands**: pytest tests/ -v (82 PASS), ruff check --fix (5 fixed), ctx sync (PASS)\n- **Pack SHA**: `e2d4e68db8438c94`\n\n## 2025-12-30 17:45 UTC\n- **Summary**: TDD v1.1 COMPLETE: Audit + Phase 3 success. Path-aware deduplication validated (nested skill.md supported), Clean Architecture imports, 82/82 tests PASS, 6 chunks (-646 tokens)\n- **Files**: src/application/use_cases.py, src/infrastructure/file_system.py, src/infrastructure/validators.py, tests/unit/test_validators.py, tests/installer_test.py, scripts/install_FP.py\n- **Commands**: audit (3 points validated), pytest tests/ -v (82 PASS), ruff check --fix (5 fixed), ctx sync (PASS)\n- **Pack SHA**: `e2d4e68db8438c94`\n\n## 2025-12-30 19:39 UTC\n- **Summary**: QA AUDIT COMPLETE: Repository consistency verified post-refactor. 0 critical issues, 3 warnings (legacy docs), 8 items verified. Entry points correct, imports robust, CLI functional.\n- **Files**: pyproject.toml, scripts/install_FP.py, README.md, docs/MIGRATION_v1.1.md\n- **Commands**: audit (7 sections), pytest (82 PASS), import tests (from root + scripts/)\n- **Pack SHA**: `cfeb632d94e6d4f3`\n\n## 2025-12-30 19:43 UTC\n- **Summary**: DOCS: Updated context-pack-implementation.md to reflect historical/foundational status. Added CLI migration notes (ingest_trifecta.py â†’ trifecta ctx), preserved original knowledge, enhanced Phase 2 SQLite section.\n- **Files**: docs/implementation/context-pack-implementation.md\n- **Commands**: documentation update (no deletions, context added)\n- **Pack SHA**: `cfeb632d94e6d4f3`\n\n## 2025-12-30 20:09 UTC\n- **Summary**: TYPE ANNOTATIONS COMPLETE: test_validators.py now passes mypy --strict with 0 errors. Added return type annotations (-> None) to all 16 test methods, Generator type for fixture, Path type hints for parameters, and type: ignore comments for intentional frozen dataclass mutation tests. Tests: 82/82 PASS. Commit 1f74cd4 pushed to origin/main.\n- **Pack SHA**: `cfeb632d94e6d4f3`\n\n## 2025-12-30 22:37 UTC\n- **Summary**: TYPE SAFETY MASTER ACHIEVEMENT: Eliminated ALL 94 mypy --strict errors across 31 files. Applied John Carmack principle (1 warning = 1 bug). Fixed core issues: CLI ValidationResult handling, Generator types, Literal types, Optional annotations, Any vs any, missing type hints on 150+ functions/params. Tests: 82/82 PASS. Production-ready type safety achieved. Commit fb39dbe.\n- **Pack SHA**: `cfeb632d94e6d4f3`\n\n## 2025-12-30 22:39 UTC\n- **Summary**: VERIFIED: mypy --strict compliance maintained (0 errors). All type annotations complete including search_get_usecases.py with Telemetry: Any type (intentional for flexibility). Project at production-grade type safety. No action needed.\n- **Pack SHA**: `f2c1f9e8811b2f74`\n\n",
      "char_count": 8189,
      "token_est": 2047,
      "source_path": "session_trifecta_dope.md",
      "chunking_method": "whole_file"
    },
    {
      "id": "ref:README.md:7707756ce5",
      "doc": "ref:README.md",
      "title_path": [
        "README.md"
      ],
      "text": "# Trifecta Generator\n\n> **North Star**: Un agente entienda cualquier segmento del repo en <60 segundos leyendo solo 3 archivos + 1 log.\n\n# Trifecta â€” Programming Context Calling (para agentes de cÃ³digo)\n\n## QuÃ© somos\nTrifecta es un **sistema de â€œProgramming Context Callingâ€** diseÃ±ado para **agentes que trabajan con cÃ³digo**.  \nTratamos el **contexto como una herramienta**: el runtime entrega al agente **un set pequeÃ±o, curado y versionado** de â€œcontext-toolsâ€ (p. ej. `prime`, `agent`, `session`, `skill`) para que el agente actÃºe con **disciplina, trazabilidad y bajo costo cognitivo**.\n\n## A quÃ© apuntamos\n- **Reducir fricciÃ³n**: que el agente no pierda tiempo explorando Ã¡rboles de carpetas ni â€œadivinandoâ€ arquitectura/estado.\n- **OperaciÃ³n repetible**: decisiones basadas en artefactos (`prime.md`, `agent.md`, `session.md`, `skill.md`), no en improvisaciÃ³n.\n- **Evidencia y auditorÃ­a**: cada paso tiene soporte (quÃ© se consultÃ³, por quÃ© y con quÃ© versiÃ³n).\n- **Control**: presupuesto de contexto, polÃ­ticas de escalada y lÃ­mites explÃ­citos.\n\n## QuÃ© solucionamos\n- â€œDeep diveâ€ innecesario por el repo para entender por dÃ³nde empezar.\n- AlucinaciÃ³n de arquitectura/stack/estado por falta de guÃ­a explÃ­cita.\n- Sesiones donde se repite trabajo porque no existe un **estado de sesiÃ³n** confiable.\n- Contextos inflados y caÃ³ticos que degradan el rendimiento del agente (â€œtodo el repo al promptâ€).\n- Falta de procedimiento: el agente no sabe â€œquÃ© hacer ahoraâ€ y deriva.\n\n## NO SOMOS (explÃ­cito y no negociable)\n**Trifecta NO ES un RAG genÃ©rico.**  \nNo es un buscador global del repositorio ni un sistema que â€œindexa todo el cÃ³digoâ€ para maximizar recall.\n\n**Trifecta NO ES una base vectorial / embeddings-first por defecto.**  \nNo depende de vectorizar `src/` ni de â€œbuscar trozosâ€ como estrategia primaria.\n\n**Trifecta NO ES â€œchat con memoriaâ€ ni un notebook de notas.**  \nNo pretende almacenar conocimiento libre o conversaciones; opera con artefactos curados y versionables.\n\n**Trifecta NO ES una excusa para explorar carpetas a ciegas.**  \nEl agente no debe recorrer 3 niveles de directorios para â€œentenderâ€ el repo: usa `prime` y la sesiÃ³n.\n\n**Trifecta NO ES un sistema de recuperaciÃ³n indiscriminada de contexto.**  \nEl objetivo no es â€œtraer mÃ¡s textoâ€, es **activar el contexto correcto** como si fuera una tool.\n\n## Principio operativo\n**Meta-first, cÃ³digo on-demand.**  \nEl agente inicia con `skill â†’ prime â†’ agent â†’ session`.  \nSolo escala a cÃ³digo cuando es estrictamente necesario y siguiendo rutas/contratos curados.\n\n## Problema\n\nLos agentes de cÃ³digo (Claude, Gemini, Codex) parsean miles de lÃ­neas de cÃ³digo innecesariamente, consumen contexto, y terminan con informaciÃ³n obsoleta o incompleta.\n\n## SoluciÃ³n\n\nEl sistema **Trifecta** proporciona una estructura estandarizada de **5 archivos** que permite:\n\n- **ComprensiÃ³n rÃ¡pida**: <60 segundos para entender un segmento\n- **Contexto eficiente**: Solo carga lo necesario (progressive disclosure)\n- **Mantenimiento simple**: Estructura predecible, sin drift\n- **Onboarding automÃ¡tico**: README con guÃ­a para nuevos agentes\n\n---\n\n## ğŸ—ï¸ Arquectura del Generador\n\n> **âš ï¸ IMPORTANTE**: Este generador ya estÃ¡ implementado con Clean Architecture. No recrear desde cero.\n\n```\ntrifecta_dope/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ domain/           # Entidades de negocio (Pydantic models)\nâ”‚   â”‚   â”œâ”€â”€ models.py     # TrifectaConfig, TrifectaPack, ValidationResult\nâ”‚   â”‚   â””â”€â”€ constants.py  # MAX_SKILL_LINES, etc.\nâ”‚   â”‚\nâ”‚   â”œâ”€â”€ application/      # Use cases (lÃ³gica de negocio)\nâ”‚   â”‚   â””â”€â”€ use_cases.py  # Create, Validate, RefreshPrime\nâ”‚   â”‚\nâ”‚   â””â”€â”€ infrastructure/   # Implementaciones concretas\nâ”‚       â”œâ”€â”€ cli.py        # Typer CLI (entrypoint)\nâ”‚       â”œâ”€â”€ templates.py  # TemplateRenderer (markdown generation)\nâ”‚       â””â”€â”€ file_system.py # FileSystemAdapter (disk I/O)\nâ”‚\nâ”œâ”€â”€ tests/                # Unit tests (pytest)\nâ”œâ”€â”€ braindope.md          # EspecificaciÃ³n completa\nâ””â”€â”€ README.md             # Este archivo\n```\n\n### Capas (Clean Architecture)\n\n| Capa | Responsabilidad | Archivos clave |\n|------|-----------------|----------------|\n| **Domain** | Modelos de datos, validadores | `models.py`, `constants.py` |\n| **Application** | Casos de uso, orquestaciÃ³n | `use_cases.py` |\n| **Infrastructure** | CLI, templates, I/O | `cli.py`, `templates.py`, `file_system.py` |\n\n### Flujo de CreaciÃ³n\n\n```\nCLI (cli.py)\n    â†“\nCreateTrifectaUseCase (use_cases.py)\n    â†“\nTemplateRenderer.render_{skill,prime,agent,session,readme}\n    â†“\nFileSystemAdapter.save_trifecta\n    â†“\n5 archivos en disco\n```\n\n### Reglas de DiseÃ±o\n\n1. **Domain** â†’ sin dependencias externas (solo Pydantic)\n2. **Application** â†’ solo depende de Domain\n3. **Infrastructure** â†’ implementa interfaces de Application/Domain\n4. **Templates** â†’ f-strings, sin Jinja2 (simplicidad)\n\n### Extensiones\n\nPara agregar un nuevo comando:\n\n1. Crear use case en `application/use_cases.py`\n2. Agregar comando en `infrastructure/cli.py`\n3. Agregar tests en `tests/test_use_cases.py`\n\n---\n\n## Estructura Trifecta (Output)\n\n```\n<segment-name>/\nâ”œâ”€â”€ README.md                              # GuÃ­a rÃ¡pida del segmento\nâ”œâ”€â”€ skill.md                               # Reglas (MAX 100 lÃ­neas)\nâ””â”€â”€ _ctx/\n    â”œâ”€â”€ prime_<segment-name>.md            # Lista de lectura\n    â”œâ”€â”€ agent.md                           # Stack tÃ©cnico\n    â””â”€â”€ session_<segment-name>.md          # Log de handoff (runtime)\n```\n\n### Archivos\n\n| Archivo | PropÃ³sito | LÃ­neas aprox |\n|---------|-----------|--------------|\n| `README.md` | GuÃ­a rÃ¡pida + onboarding | ~50-80 |\n| `skill.md` | Reglas, contratos, workflows | â‰¤100 |\n| `prime_*.md` | Lista de lectura obligatoria | ~50-100 |\n| `agent.md` | Stack tÃ©cnico, dependencies | ~100-150 |\n| `session_*.md` | BitÃ¡cora de handoffs | Append-only |\n\n## Perfiles de Output\n\nEl sistema usa perfiles (nvim-style modeline) para definir contratos de output:\n\n| Profile | PropÃ³sito | Contract |\n|---------|-----------|----------|\n| `diagnose_micro` | MÃ¡ximo texto, cÃ³digo â‰¤3 lÃ­neas | `code_max_lines: 3` |\n| `impl_patch` | Patch con verificaciÃ³n | `require: [FilesTouched, CommandsToVerify]` |\n| `only_code` | Solo archivos + diff + comandos | `forbid: [explanations]` |\n| `plan` | DoD + pasos (sin cÃ³digo) | `forbid: [code_blocks]` |\n| `handoff_log` | BitÃ¡cora + handoff | `append_only: true` |\n\n## Progressive Disclosure\n\n| Nivel | Trigger | Tokens |\n|-------|---------|--------|\n| **L0** | Score < 0.6 | ~50 (solo frontmatter) |\n| **L1** | Score 0.6-0.9 | ~500-1000 (skill completo) |\n| **L2** | Score > 0.9 | ~200-500 (resources) |\n\n## Uso\n\n### 1. Alias (Recomendado)\nPara usar `trifecta` desde cualquier carpeta sin instalarlo globalmente:\n\n```fish\n# Agregar a ~/.config/fish/config.fish\nalias trifecta=\"/Users/felipe_gonzalez/.local/bin/uv --directory /Users/felipe_gonzalez/Developer/agent_h/trifecta_dope run trifecta\"\n```\n\nLuego:\n```bash\ncd ~/Developer/AST\ntrifecta ctx build .\n```\n\n### 2. EjecuciÃ³n Directa (Sin Alias)\n```bash\n# Desde cualquier directorio\nuv --directory ~/Developer/agent_h/trifecta_dope run trifecta load --path ~/Developer/AST --segment ast --task \"Fix bug\"\n```\n\n### 3. Autocompletado (Fish)\nPara tener autocompletado nativo en todos los comandos:\n\n```bash\nmkdir -p ~/.config/fish/completions\nln -s $(pwd)/completions/trifecta.fish ~/.config/fish/completions/trifecta.fish\nsource ~/.config/fish/completions/trifecta.fish\n```\n\n### Generar Trifecta (Ejemplos)\n```bash\n# Crear trifecta para un segmento\ntrifecta create --segment eval-harness --path eval/eval-harness/ --scan-docs eval/docs/\n\n# Validar trifecta existente\ntrifecta validate --path eval/eval-harness/\n```\n\n### Generar Context Pack (Programming Context Calling)\n\nEl **Context Pack** es un Ã­ndice estructurado que permite al agente:\n1. Descubrir quÃ© chunks existen (`ctx.search`)\n2. Invocar chunks especÃ­ficos (`ctx.get --ids X`)\n3. Operar con presupuesto estricto (budget-aware)\n\n**AnalogÃ­a**: Como \"Tool Search Tool\" de Anthropic, pero para contexto.\n\n```bash\n# Comando oficial (recomendado)\ntrifecta ctx build --segment /path/to/segment\n\n# Validar integridad\ntrifecta ctx validate --segment /path/to/segment\n```\n\n> **DEPRECADO**: `scripts/ingest_trifecta.py` serÃ¡ removido en v2.  \n> Usar solo para debugging interno del CLI.\n\n**Estructura del Context Pack:**\n\n```json\n{\n  \"schema_version\": 1,\n  \"segment\": \"debug_terminal\",\n  \"created_at\": \"2025-12-29T15:47:37.502279Z\",\n  \"digest\": [           // Siempre en prompt (~10-30 lÃ­neas)\n    {\"doc\": \"skill\", \"summary\": \"...\", \"source_chunk_ids\": [...]}\n  ],\n  \"index\": [            // Siempre en prompt (referencias)\n    {\"id\": \"skill:a1b2...\", \"title_path\": [...], \"preview\": \"...\", \"token_est\": 150}\n  ],\n  \"chunks\": [           // Entregado bajo demanda vÃ­a tool\n    {\"id\": \"skill:a1b2...\", \"text\": \"...\", \"source_path\": \"...\"}\n  ]\n}\n```\n\n**CÃ³mo funciona:**\n\n1. **Prompt base** incluye solo `digest` + `index` (referencias)\n2. **Agente llama** `ctx.get --ids X` cuando necesita evidencia especÃ­fica\n3. **Sistema entrega** chunks dentro del presupuesto (budget-aware)\n4. **Agente cita** evidencia con `[chunk_id]`\n\n**El agente decide quÃ© cargar, cuÃ¡ndo y con quÃ© presupuesto. NO es recuperaciÃ³n automÃ¡tica.**\n\n> Ver [`docs/plans/2025-12-29-context-pack-ingestion.md`](./docs/plans/2025-12-29-context-pack-ingestion.md) para especificaciÃ³n completa.\n\n## ğŸ”§ Mini-RAG (Herramienta de Desarrollo)\n\n> **NOTA**: Mini-RAG es una herramienta **externa** para que TÃš (desarrollador) consultes  \n> la documentaciÃ³n del CLI. **NO es parte del paradigma Trifecta.**\n\nTrifecta usa bÃºsqueda lexical (grep-like), NO embeddings.\n\n### Setup (solo para desarrollo del CLI)\n\n```bash\n# Desde la raÃ­z del proyecto\nmake minirag-setup MINIRAG_SOURCE=~/Developer/Minirag\nmake minirag-index\n```\n\n### Consultas\n\n```bash\nmake minirag-query MINIRAG_QUERY=\"PCC\"\n```\n\n> El Ã­ndice usa `docs/**/*.md` y `knowledge/**` definidos en `.mini-rag/config.yaml`.\n\n**Para agentes**: Usar `trifecta ctx search`, NO Mini-RAG.\n\n## InstalaciÃ³n\n\n```bash\ncd trifecta_dope\nuv sync\n```\n\n### Multi-Segment Installation\n\nPara instalar contexto en mÃºltiples segmentos del repositorio, usa el script estable:\n\n```bash\n# Script recomendado (Clean Architecture compliant)\nuv run python scripts/install_FP.py --segment /path/to/segment1 --segment /path/to/segment2\n\n# DEPRECATED: scripts/install_trifecta_context.py (backward compatibility only)\n```\n\nEl script `install_FP.py` utiliza validadores desde `src/infrastructure/validators.py` y sigue principios de Clean Architecture.\n\n## Tests\n\n```bash\nuv run pytest tests/ -v\n```\n\n## Desarrollo\n\n```bash\n# Ejecutar CLI con Typer\nuv run typer src/infrastructure/cli.py run create --help\n```\n\n## Referencias\n\n- [`docs/braindope.md`](./docs/braindope.md) - EspecificaciÃ³n completa del sistema\n- [`writing-skills`](../.claude/skills/superpowers/writing-skills/) - MetodologÃ­a para crear SKILL.md\n\n## Roadmap\n\n### CLI & Templates\n- [x] EspecificaciÃ³n completa (braindope.md)\n- [x] Clean Architecture implementation\n- [x] CLI con comandos `create`, `validate`, `refresh-prime`\n- [x] README.md automÃ¡tico en cada segmento\n- [x] Enhanced templates (skill, agent, prime) con ejemplos concretos\n- [x] CLI UX improvements: validaciÃ³n, errores contextuales, dry-run\n- [x] Fish shell completions\n\n### Context Pack\n- [x] Context Pack ingestion script (token-optimized)\n- [x] Schema v1 con digest + index + chunks\n- [x] Fence-aware chunking (respeta bloques de cÃ³digo)\n- [x] Digest determinista (scoring system)\n- [x] IDs estables (normalized hash)\n- [x] E2E tests (34 tests passing)\n\n### Pending\n- [ ] Prueba con segmentos reales (`debug_terminal`, `hemdov`, `eval`)\n- [ ] MCP Discovery Tool para activaciÃ³n automÃ¡tica\n- [ ] Progressive Disclosure (L0/L1/L2) en hooks\n\n---\n\n## ğŸ› ï¸ Best Practices & Troubleshooting\n\n### 1. Reglas de Oro para OperaciÃ³n Multi-Workspace\n*   **Target Segment**: Usa siempre `--segment /path/to/target`. El flag `--path` estÃ¡ deprecado para comandos `ctx` y `load`.\n*   **Validar PCC**: Si quieres usar Plan A (bÃºsqueda inteligente), verifica que exista `segment/_ctx/context_pack.json`. Si no existe, corre `trifecta ctx build --segment ...`.\n\n### 2. DepuraciÃ³n de BÃºsqueda (0 Hits)\nSi `trifecta load` cae a fallback cuando no deberÃ­a:\n1.  **DiagnÃ³stico**: Ejecuta `trifecta ctx search --segment Path --query \"keyword\"`.\n2.  **Causa**: Si retorna vacÃ­o, tus palabras clave no estÃ¡n en el Ã­ndice.\n3.  **SoluciÃ³n**:\n    *   Agrega los documentos relevantes a `segment/_ctx/prime_*.md`.\n    *   Regenera el Ã­ndice: `trifecta ctx build --segment Path`.\n\n### 3. Rutas Hardcoded\nEl CLI imprime lo que lee. Si ves rutas extraÃ±as en el output de `load`, provienen de los archivos del segmento (`prime`, `agent`, `skill`), no del CLI. Edita los archivos del segmento para corregirlas.\n",
      "char_count": 12707,
      "token_est": 3176,
      "source_path": "README.md",
      "chunking_method": "whole_file"
    },
    {
      "id": "ref:RELEASE_NOTES_v1.md:e2b673d762",
      "doc": "ref:RELEASE_NOTES_v1.md",
      "title_path": [
        "RELEASE_NOTES_v1.md"
      ],
      "text": "# Trifecta Context Loading v1 â€” Release Notes\n\n**Status**: Verified & Ready for Integration\n**Date**: 2025-12-29\n\n## ğŸš€ What's Included\n1.  **Plan A (Programmatic Context Calling)**:\n    - `ctx search`: Lexical search with top-k limits.\n    - `ctx get`: ID-based retrieval with budget awareness (value-per-token sorting).\n2.  **Plan B (Fallback Strategy)**:\n    - `load --mode fullfiles`: Resilient loading when packs are missing or access is critical.\n3.  **Strict Validation Gates**:\n    - Atomic writes (`_ctx/.autopilot.lock`).\n    - Fail-closed validation (SHA-256 deep checks).\n4.  **Dumb Macro Sync**:\n    - `ctx sync`: Fixed macro (`build` + `validate`) for deterministic state.\n\n## âš ï¸ Known Limitations (v1)\n- **No Embeddings**: Search is purely lexical (grep-like heuristics).\n- **Documentation Only Contracts**: `session.md` YAML is for reference; not executed by the system.\n- **Segment-Local Only**: No global index; operations are scoped to the current segment.\n\n## ğŸ› ï¸ Usage Guide (Top 5 Commands)\n\n### 1. Build & Sync (Routine Maintenance)\n```bash\ntrifecta ctx sync --segment .\n```\n\n### 2. Search (Discovery)\n```bash\ntrifecta ctx search --segment . --query \"authentication\" --limit 5\n```\n\n### 3. Get Context (retrieval)\n```bash\ntrifecta ctx get --segment . --ids \"skill:1,agent:3\" --budget-token-est 1000\n```\n\n### 4. Create New Pack (Setup)\n```bash\nmake trifecta-create SEGMENT=my-feature PATH=.\n```\n\n### 5. Fallback Load (Emergency)\n```bash\ntrifecta load --segment . --task \"rescue mission\" --mode fullfiles\n```\n\n## ğŸ› Bug Reporting\nAttach the following files:\n- `_ctx/autopilot.log` (if available)\n- `_ctx/context_pack.json`\n- `_ctx/validation_report.json` (if verification fails)\n",
      "char_count": 1696,
      "token_est": 424,
      "source_path": "RELEASE_NOTES_v1.md",
      "chunking_method": "whole_file"
    }
  ],
  "index": [
    {
      "id": "skill:773705da1d",
      "title_path_norm": "skill.md",
      "preview": "---\nname: trifecta_dope\ndescription: Use when working on Verification\n---\n## Overview\nVerification\n\n**UbicaciÃ³n**: `/Users/felipe_gonzalez/Developer/agent_h/trifecta_dope/`\n\n## âš ï¸ ONBOARDING OBLIGATOR...",
      "token_est": 885
    },
    {
      "id": "agent:39151e4814",
      "title_path_norm": "agent.md",
      "preview": "---\nsegment: .\nscope: Verification\nrepo_root: /Users/felipe_gonzalez/Developer/agent_h\nlast_verified: 2025-12-29\ndefault_profile: impl_patch\n---\n\n# Agent Context - .\n\n## Source of Truth\n\n| SecciÃ³n | F...",
      "token_est": 726
    },
    {
      "id": "prime:48de346017",
      "title_path_norm": "prime_trifecta_dope.md",
      "preview": "---\nsegment: trifecta-dope\nprofile: load_only\n---\n\n# Prime Trifecta Dope - Lista de Lectura\n\n> **REPO_ROOT**: `/Users/felipe_gonzalez/Developer/agent_h/trifecta_dope`\n> Todas las rutas son relativas a...",
      "token_est": 345
    },
    {
      "id": "session:99cac305f7",
      "title_path_norm": "session_trifecta_dope.md",
      "preview": "# session.md - Trifecta Context Runbook\n\nsegment: trifecta-dope\n\n## Purpose\nThis file is a **runbook** for using Trifecta Context tools efficiently:\n- progressive disclosure (search -> get)\n- strict b...",
      "token_est": 2047
    },
    {
      "id": "ref:README.md:7707756ce5",
      "title_path_norm": "README.md",
      "preview": "# Trifecta Generator\n\n> **North Star**: Un agente entienda cualquier segmento del repo en <60 segundos leyendo solo 3 archivos + 1 log.\n\n# Trifecta â€” Programming Context Calling (para agentes de cÃ³dig...",
      "token_est": 3176
    },
    {
      "id": "ref:RELEASE_NOTES_v1.md:e2b673d762",
      "title_path_norm": "RELEASE_NOTES_v1.md",
      "preview": "# Trifecta Context Loading v1 â€” Release Notes\n\n**Status**: Verified & Ready for Integration\n**Date**: 2025-12-29\n\n## ğŸš€ What's Included\n1.  **Plan A (Programmatic Context Calling)**:\n    - `ctx search`...",
      "token_est": 424
    }
  ]
}