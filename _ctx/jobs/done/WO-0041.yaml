version: 1
id: WO-0041
epic_id: E-LSP-CONTRACT
title: Definir READY como contrato con invariantes
priority: P0
status: done
owner: felipe_gonzalez
branch: feat/wo-WO-0041
worktree: ../.worktrees/WO-0041
scope:
  allow:
  - src/infrastructure/lsp_client.py
  - src/infrastructure/lsp_daemon.py
  - src/application/lsp_manager.py
  - tests/integration/test_ready_semantics_documented_and_enforced.py
  - tests/integration/test_lsp_contract_fallback.py
  - docs/contracts/LSP_READY_INVARIANTS.md
  deny:
  - .env*
  - '**/production.*'
verify:
  commands:
  - uv run pytest tests/integration/test_ready_semantics_documented_and_enforced.py -v
  - uv run pytest tests/integration/test_lsp_contract_fallback.py -v
dod_id: DOD-DEFAULT
execution:
  engine: trifecta
  required_flow:
  - session.append:intent
  - ctx.sync
  - ctx.search
  - ctx.get
  - session.append:result
  - verify
  segment: .
trace:
  ticket: null
  related_wos:
  - WO-0040
  - WO-0044
claim_links:
  requirements:
  - READY requiere handshake LSP completado
  - READY requiere proceso vivo
  - READY requiere workspace root correcto
  - READY requiere health check < 500ms
  assumptions:
  - LSP server (pyright/pylsp) disponible en PATH
  constraints:
  - No aumentar latency de cold start > 200ms
  - Mantener backward compatibility en eventos existentes
objective: "Introducir READY invariants m\xEDnimos para garantizar que READY realmente significa operativo.\n\
  READY actual significa \"inicializado\" pero no garantiza capacidad de servir requests.\n"
started_at: '2026-02-16T00:34:10.799968+00:00'
result: done
verified_at_sha: 6426f1efea1f36f982f7866463662900bdb43e6e
deliverables:
- Handshake LSP completado (initialize/initialized)
- Proceso vivo (pid check)
- Workspace root = segment root correcto
- Request health/ping o capability-check responde en <X ms
- Evento lsp.state_change incluye reason + failed_invariant
- "Si falla invariante \u2192 no puede reportarse READY"
diff_budget:
  max_files: 6
  max_loc: 250
stop_conditions:
  max_iterations: 5
  max_fail_verify: 2
closed_at: '2026-02-16T00:59:20.255319+00:00'
