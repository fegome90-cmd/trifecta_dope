version: 1
id: WO-0023
epic_id: E-0001
title: "Fase 2 - Hardening: Introspecci\xF3n runtime + Telemetry + Anti-alucinaci\xF3n"
priority: P1
status: done
owner: null
scope:
  allow:
  - src/cli/invalid_option_handler.py
  - src/cli/introspection.py
  - src/infrastructure/cli.py
  - src/infrastructure/telemetry_cli.py
  - tests/unit/cli/test_introspection.py
  - tests/integration/test_cli_introspection.py
  - tests/golden/cli_flags_*.json
  - scripts/verify_cli_introspection.sh
  - docs/reports/cli_fase2_hardening.md
  deny:
  - .env*
  - '**/production.*'
  - src/domain/**
  - docs/backlog/**
verify:
  commands:
  - uv run pytest tests/unit/cli/test_introspection.py -v
  - uv run pytest tests/integration/test_cli_introspection.py -v
  - bash scripts/verify_cli_introspection.sh WO-0023
  - test -f docs/reports/cli_fase2_hardening.md
dod_id: DOD-DEFAULT
execution:
  engine: trifecta
  required_flow:
  - session.append:intent
  - ctx.sync
  - ctx.search
  - ctx.get
  - session.append:result
  segment: .
dependencies:
- WO-0022
x_objective: "Fase 2 - Hardening del sistema de opciones inv\xE1lidas.\n\nReemplazar el mapping est\xE1\
  tico de flags por introspecci\xF3n runtime de Click/Typer.\nImplementar telemetry para medir KPIs reales\
  \ (help_first_used, invalid_option_count).\nGarantizar que el handler nunca \"alucine\" flags (fail-closed).\n\
  \nFases:\n0. Contrato y DoD por \xEDtem\n1. Introspecci\xF3n runtime (core) - extraer flags reales de\
  \ Click\n2. Handler determinista (anti-alucinaci\xF3n) - sugerencias \u2286 flags v\xE1lidos\n3. Telemetry\
  \ m\xEDnima pero \xFAtil - eventos JSONL para KPIs\n4. Tests de regresi\xF3n - golden tests con snapshots\
  \ runtime\n5. Documentaci\xF3n y cierre - README + verify.sh\n\nPrincipios:\n- Una sola fuente de verdad\
  \ (Click/Typer, no diccionarios)\n- Gates autom\xE1ticos (tests + verify.sh)\n- Evidencia en telemetry\
  \ (no \"creo que...\")\n- Fail-closed (si no se puede resolver comando \u2192 no sugerir)\n- Scope congelado:\
  \ ctx, ctx sync, ctx build, create (m\xEDnimo ROI)\n"
deliverables:
- "src/cli/introspection.py - Introspecci\xF3n pura de Click"
- src/cli/invalid_option_handler.py v2 - Con runtime flags
- src/infrastructure/telemetry_cli.py - Eventos JSONL
- tests/golden/cli_flags_*.json - Snapshots de flags por comando
- "scripts/verify_cli_introspection.sh - Gate de verificaci\xF3n"
- "docs/reports/cli_fase2_hardening.md - Reporte de m\xE9tricas"
