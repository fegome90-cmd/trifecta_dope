version: 1
id: WO-0044
epic_id: E-LSP-CONTRACT
title: "Telemetr\xEDa m\xEDnima de salud LSP"
priority: P0
status: done
scope:
  allow:
  - src/infrastructure/lsp_client.py
  - src/infrastructure/lsp_daemon.py
  - src/application/telemetry_pr2.py
  - src/application/telemetry_reports.py
  - src/infrastructure/telemetry.py
  - tests/integration/test_lsp_telemetry_health.py
  - tests/unit/test_telemetry_health.py
  deny:
  - .env*
  - '**/production.*'
  - docs/**
verify:
  commands:
  - uv run pytest tests/integration/test_lsp_telemetry_health.py -v
  - uv run pytest tests/unit/test_telemetry_health.py -v
  - uv run trifecta telemetry health -s .
  - make gate-all
dod_id: DOD-DEFAULT
execution:
  engine: trifecta
  required_flow:
  - verify
  segment: .
trace:
  ticket: null
  related_wos:
  - WO-0040
  - WO-0041
claim_links:
  requirements:
  - "M\xE9tricas de salud emitidas en cada operaci\xF3n cr\xEDtica"
  - "Dashboard/report b\xE1sico funcional"
  - Eventos de error incluyen contexto suficiente
  assumptions:
  - Telemetry system base funciona
  - LSP daemon lifecycle estable
  constraints:
  - No impactar performance de requests (>5% latency)
  - Mantener compatibilidad con eventos existentes
objective: "Agregar m\xE9tricas/eventos m\xEDnimos de salud LSP para no operar a ciegas.\nDetectar problemas\
  \ antes de que causen fallos silenciosos.\n"
deliverables:
- Contador lsp.thread_alive_after_join (edge case en shutdown)
- Contador lsp.ready_fail_invariant (cuando invariantes fallan)
- "Latencia p95 de request b\xE1sica (hover/ping)"
- 'Evento lsp.daemon_status con: state, uptime, last_request_ms, root_ok'
- "Dashboard/report b\xE1sico: trifecta telemetry health -s ."
- "Tests de telemetr\xEDa: verificar eventos emitidos correctamente"
diff_budget:
  max_files: 8
  max_loc: 350
stop_conditions:
  max_iterations: 5
  max_fail_verify: 2
