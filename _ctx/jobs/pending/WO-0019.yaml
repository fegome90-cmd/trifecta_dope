version: 1
id: WO-0019
epic_id: E-0013
title: Migrate Legacy WOs to Schema v1
priority: P2
status: pending
owner: null
scope:
  allow:
  - _ctx/jobs/**/*.yaml
  - docs/backlog/schema/**
  - scripts/schema_validation.py
  deny:
  - src/domain/**
  - tests/**
  - src/infrastructure/**
verify:
  commands:
  - python3 scripts/schema_validation.py --root .
dod_id: DOD-DEFAULT
execution:
  engine: trifecta
  required_flow:
  - session.append:intent
  - ctx.sync
  - ctx.search
  - ctx.get
  - session.append:result
  segment: .
dependencies:
- WO-0018B
- WO-0011
- WO-0018A
verified_at_sha: null
closed_at: null
run_ids:
- wo-0019-inventory
- wo-0019-migrate
- wo-0019-verify
x_objective: 'Migrate 16 legacy WOs that fail schema validation to comply with schema v1.

  These WOs were created before schema enforcement and have missing required fields,

  invalid properties, or incorrect formats.

  '
x_phases:
  1: Inventory and categorize failing WOs
  2: Fix schema violations
  3: Verify all WOs pass validation
  4: Update backlog documentation
x_micro_tasks:
- id: T1
  name: 'T1: Inventory failing WOs'
  status: pending
  commands:
  - python3 scripts/schema_validation.py --root . 2>&1 | tee /tmp/wo_validation.log
  - 'grep ''FAILED'' /tmp/wo_validation.log | cut -d: -f1 > /tmp/failing_wos.txt'
  - cat /tmp/failing_wos.txt
  gates:
  - test -s /tmp/failing_wos.txt
  - test $(wc -l < /tmp/failing_wos.txt) -ge 1
  evidence:
  - /tmp/failing_wos.txt
  - /tmp/wo_validation.log
  commit: 'chore(wo): inventory of schema validation failures'
- id: T2
  name: 'T2: Categorize failure types'
  status: pending
  commands:
  - echo '# Schema Violations Summary' > /tmp/violations_report.md
  - echo '## Missing Fields' >> /tmp/violations_report.md
  - grep -E "'(verify|scope)' is a required property" /tmp/wo_validation.log | wc -l >> /tmp/violations_report.md
  - echo '## Invalid Properties' >> /tmp/violations_report.md
  - grep -E "does not match any of the regexes" /tmp/wo_validation.log | wc -l >> /tmp/violations_report.md
  - cat /tmp/violations_report.md
  gates:
  - test -s /tmp/violations_report.md
  evidence:
  - /tmp/violations_report.md
  commit: 'docs(wo): categorize schema violation types'
- id: T3
  name: 'T3: Fix missing verify/scope fields'
  status: pending
  commands:
  - '# For each WO missing verify, add: verify: { commands: [] }'
  - '# For each WO missing scope, add: scope: { allow: [], deny: [] }'
  - python3 << 'EOF'
  - import yaml
  - from pathlib import Path
  - ''
  - 'for wo_file in Path(''_ctx/jobs'').rglob(''WO-*.yaml''):'
  - '    with open(wo_file) as f:'
  - '        data = yaml.safe_load(f)'
  - '    if ''verify'' not in data:'
  - '        data[''verify''] = {''commands'': []}'
  - '        print(f''Adding verify to {wo_file}'')'
  - '    if ''scope'' not in data:'
  - '        data[''scope''] = {''allow'': [], ''deny'': []}'
  - '        print(f''Adding scope to {wo_file}'')'
  - '    with open(wo_file, ''w'') as f:'
  - '        yaml.dump(data, f, default_flow_style=False, sort_keys=False)'
  - EOF
  gates:
  - python3 scripts/schema_validation.py --root . 2>&1 | tee /tmp/after_t3.log
  - '! grep -E "''(verify|scope)'' is a required property" /tmp/after_t3.log'
  evidence:
  - /tmp/after_t3.log
  commit: 'fix(wo): add missing verify/scope fields to legacy WOs'
- id: T4
  name: 'T4: Fix invalid properties in verify'
  status: pending
  commands:
  - '# WO-0011 has verified_at_sha in verify (should be at root or x_verified_at_sha)'
  - '# Move verified_at_sha from verify to root level'
  - python3 << 'EOF'
  - import yaml
  - from pathlib import Path
  - ''
  - wo_file = Path('_ctx/jobs/pending/WO-0011.yaml')
  - 'if wo_file.exists():'
  - '    with open(wo_file) as f:'
  - '        data = yaml.safe_load(f)'
  - '    if ''verify'' in data and ''verified_at_sha'' in data.get(''verify'', {}):'
  - '        # Move to root if not already there'
  - '        if ''verified_at_sha'' not in data:'
  - '            data[''verified_at_sha''] = data[''verify''][''verified_at_sha'']'
  - '        del data[''verify''][''verified_at_sha'']'
  - '        with open(wo_file, ''w'') as f:'
  - '            yaml.dump(data, f, default_flow_style=False, sort_keys=False)'
  - '        print(f''Moved verified_at_sha from verify to root in WO-0011'')'
  - EOF
  gates:
  - grep -q 'verified_at_sha:' _ctx/jobs/**/WO-0011.yaml 2>/dev/null
  - '! grep -A5 ''verify:'' _ctx/jobs/**/WO-0011.yaml | grep -q ''verified_at_sha:'''
  evidence:
  - _ctx/jobs/pending/WO-0011.yaml
  commit: 'fix(wo): move verified_at_sha to root level in WO-0011'
- id: T5
  name: 'T5: Fix governance.must format'
  status: pending
  commands:
  - '# WO-0018B has free text in governance.must instead of WO-XXXX'
  - '# Option 1: Remove invalid entries'
  - '# Option 2: Move to x_governance_notes (custom field)'
  - python3 << 'EOF'
  - import yaml
  - from pathlib import Path
  - ''
  - 'for wo_file in Path(''_ctx/jobs'').rglob(''WO-*.yaml''):'
  - '    with open(wo_file) as f:'
  - '        data = yaml.safe_load(f)'
  - '    if ''governance'' in data and ''must'' in data.get(''governance'', {}):'
  - '        # Filter to valid WO IDs only'
  - '        valid_must = [w for w in data[''governance''][''must''] if w.startswith(''WO-'')]'
  - '        invalid_count = len(data[''governance''][''must'']) - len(valid_must)'
  - '        if invalid_count > 0:'
  - '            print(f''{wo_file}: Removing {invalid_count} invalid governance entries'')'
  - '            if valid_must:'
  - '                data[''governance''][''must''] = valid_must'
  - '            else:'
  - '                del data[''governance''][''must'']'
  - '            with open(wo_file, ''w'') as f:'
  - '                yaml.dump(data, f, default_flow_style=False, sort_keys=False)'
  - EOF
  gates:
  - python3 scripts/schema_validation.py --root . 2>&1 | tee /tmp/after_t5.log
  - '! grep -i ''governance.must'' /tmp/after_t5.log'
  evidence:
  - /tmp/after_t5.log
  commit: 'fix(wo): remove invalid entries from governance.must'
- id: T6
  name: 'T6: Final verification'
  status: pending
  commands:
  - python3 scripts/schema_validation.py --root . 2>&1 | tee /tmp/final_validation.log
  - echo '## Validation Results' > /tmp/final_report.md
  - echo '' >> /tmp/final_report.md
  - grep 'Summary:' /tmp/final_validation.log >> /tmp/final_report.md
  - if grep -q 'FAILED' /tmp/final_validation.log; then
  - '  echo '''' >> /tmp/final_report.md'
  - '  echo ''## Remaining Failures'' >> /tmp/final_report.md'
  - '  grep ''FAILED'' /tmp/final_validation.log >> /tmp/final_report.md'
  - fi
  - cat /tmp/final_report.md
  gates:
  - test -f /tmp/final_validation.log
  - grep -q 'Summary:' /tmp/final_validation.log
  evidence:
  - /tmp/final_validation.log
  - /tmp/final_report.md
  commit: 'chore(wo): complete WO schema migration'
