# WO-0055: Fix WO manual-closure bypass - Hook not installed
# Created: 2026-02-17
# Priority: P1 (security/correctness)
# Status: pending

id: WO-0055
title: "Fix WO manual-closure hook: design vs actual mismatch"
priority: P1
status: pending
created: 2026-02-17
owner: null
branch: null
started: null

description: |
  The WO closure prevention hook has a critical mismatch between design and actual implementation.
  
  PROBLEM:
  - The actual `.git/hooks/pre-commit` is a 24-line stub that only syncs context pack
  - It does NOT call `prevent_manual_wo_closure.sh`
  - It does NOT check for WO closure validity
  - It has NO bypass logic
  
  The comprehensive hook at `scripts/hooks/pre-commit` (53 lines) with bypass mechanisms:
  - TRIFECTA_HOOKS_DISABLE=1 env var bypass
  - [emergency]/[bypass] commit message detection
  - Proper WO closure validation
  
  BUT THIS HOOK IS NOT INSTALLED to `.git/hooks/pre-commit`!
  
  Additionally, the pre-commit framework uses `scripts/prevent_manual_wo_closure.sh` (81 lines)
  which has NO bypass mechanism, creating inconsistency.

impact:
  - WO closure gates can be bypassed by simply not using pre-commit framework
  - Documented bypass mechanisms (TRIFECTA_HOOKS_DISABLE, [emergency]) don't work
  - Security mechanism is effectively a placebo

deliverables:
  - Install scripts/hooks/pre-commit to .git/hooks/pre-commit OR
  - Update pre-commit framework to use scripts/hooks/prevent_manual_wo_closure.sh with bypass
  - "Ensure bypass mechanisms work:"
    - "TRIFECTA_HOOKS_DISABLE=1 should disable all hooks"
    - "TRIFECTA_WO_BYPASS_REASON=... should allow WO-specific bypass (auditable)"
    - "[emergency] or [bypass] in commit message should allow (legacy support)"
  - Add tests for bypass scenarios (allow/block)
  - Document the correct bypass procedure in AGENTS.md

dod:
  - criterion: "Hook correctly validates WO closure via ctx_wo_finish.py"
  - criterion: "TRIFECTA_HOOKS_DISABLE=1 bypass works and is documented"
  - criterion: "TRIFECTA_WO_BYPASS_REASON env var bypass works (auditable)"
  - criterion: "[emergency] in commit message works as fallback"
  - criterion: "Bypass usage is logged/traceable"
  - criterion: "At least 2 tests (allow/block) executable in CI"

design_recommendation: |
  Priority: Support TRIFECTA_WO_BYPASS_REASON="..." (auditable, scoped to WO only).
  Maintain TRIFECTA_HOOKS_DISABLE=1 as "break glass" (disables ALL hooks).
  
  Pseudo-logic:
  1. If TRIFECTA_HOOKS_DISABLE=1 -> allow, log warning
  2. Else if TRIFECTA_WO_BYPSS_REASON set -> allow, log reason
  3. Else if .git/COMMIT_EDITMSG contains [emergency] -> allow
  4. Else -> validate WO closure via ctx_wo_finish.py logic

related_files:
  - scripts/hooks/pre-commit
  - scripts/hooks/prevent_manual_wo_closure.sh
  - scripts/prevent_manual_wo_closure.sh
  - .git/hooks/pre-commit
  - .pre-commit-config.yaml
  - AGENTS.md

evidence:
  - Finding: ".git/hooks/pre-commit is 24-line stub, not the 53-line design hook"
  - Finding: "TRIFECTA_HOOKS_DISABLE bypass exists in design but never executed"
  - Finding: "[emergency] bypass exists in scripts/hooks/prevent_manual_wo_closure.sh but never called"
