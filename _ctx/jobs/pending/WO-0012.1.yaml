version: 1
id: WO-0012.1
epic_id: E-0001
title: "Enable AST Persistence in Dev CLI (Real Default)"
priority: P1
status: pending
owner: null
verified_at_sha: null
closed_at: null

scope:
  allow:
    - ".envrc" # direnv config
    - "scripts/dev_env.sh" # Alternative: shell script
    - "Makefile" # Alternative: make targets with export
    - "eval/scripts/verify_ast_persist_cli.sh" # CLI verification script
  deny:
    - "src/domain/**"
    - "pyproject.toml" # Already done in WO-0012, limited to pytest

dod_id: DOD-DEFAULT

governance:
  must:
    - "Verify CLI behavior WITHOUT explicit env var"
    - "Confirm DB file creation in dev CLI mode"
    - "Extract telemetry events from dev CLI execution"
    - "Update _ctx/session_trifecta_dope.md"
    - "Commit with SHA verification"

x_objective: |
  Enable TRIFECTA_AST_PERSIST=1 by default in development CLI environment.
  This completes WO-0012 scope by activating persistence for REAL dev usage,
  not just pytest execution.

x_acceptance_criteria:
  - "Running `uv run trifecta ast symbols <file>` creates .trifecta/cache/*.db"
  - "Telemetry shows ast.cache.hit/miss events without explicit env var"
  - "Rollback via `unset TRIFECTA_AST_PERSIST` or `TRIFECTA_AST_PERSIST=0` works"
  - "Evidence collected from real CLI execution (not test harness)"

x_micro_tasks:
  - id: T1
    name: "T1: Pre-Verification (Confirm Current Behavior)"
    status: pending
    commands:
      - "rm -f .trifecta/cache/*.db" # Clean slate
      - "uv run trifecta ast symbols src/domain/models.py --segment . --telemetry full"
      - "ls -lh .trifecta/cache/*.db || echo 'No DB file (expected if no default)'"
    gates:
      - "echo 'Establishing baseline without default flag'"
    evidence:
      - "Terminal output showing DB presence/absence"
    commit: "None"

  - id: T2
    name: "T2: Choose & Implement Dev Default Mechanism"
    status: pending
    commands:
      - "echo 'export TRIFECTA_AST_PERSIST=1' > .envrc && direnv allow . || echo 'direnv not installed, using alternative'"
      - "# Alternative: Create scripts/dev_env.sh with export TRIFECTA_AST_PERSIST=1"
    gates:
      - "test -f .envrc || test -f scripts/dev_env.sh"
    evidence:
      - ".envrc or scripts/dev_env.sh"
    commit: "config: add dev environment default for AST persistence"

  - id: T3
    name: "T3: CLI Verification (Real Default Test)"
    status: pending
    commands:
      - "rm -f .trifecta/cache/*.db"
      - "# If using direnv: just run CLI directly (direnv auto-loads)"
      - "uv run trifecta ast symbols src/domain/models.py --segment . --telemetry full | tee _ctx/logs/wo_0012_1/t3_cli_verify.log"
      - "ls -lh .trifecta/cache/*.db" # Should exist now
    gates:
      - "test -f .trifecta/cache/ast_cache_*.db" # DB file must exist
      - "rg -q 'ast.cache' _ctx/telemetry/events.jsonl" # Telemetry must show cache events
    evidence:
      - "_ctx/logs/wo_0012_1/t3_cli_verify.log"
      - ".trifecta/cache/*.db presence"
    commit: "None"

  - id: T4
    name: "T4: Rollback Verification"
    status: pending
    commands:
      - "TRIFECTA_AST_PERSIST=0 uv run trifecta ast symbols src/domain/models.py --segment ."
      - "# Verify system still works (uses memory cache instead)"
    gates:
      - "echo 'Rollback capability verified'"
    evidence:
      - "Manual verification"
    commit: "None"

  - id: T5
    name: "T5: Governance & Close"
    status: pending
    commands:
      - "git status --short"
      - "git rev-parse HEAD"
    gates:
      - "test -f _ctx/jobs/done/WO-0012.1.yaml"
    evidence:
      - "Closed WO with verified SHA"
    commit: "docs(ops): close WO-0012.1 dev CLI persistence"

dependencies:
  - WO-0012
