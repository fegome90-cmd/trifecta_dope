version: 1
id: WO-0048
epic_id: E-SCALE
title: SSOT SegmentRef Sweep + Anti-Drift Guard
priority: P0
status: running
owner: felipe_gonzalez
branch: feat/wo-WO-0048
worktree: ../.worktrees/WO-0048
scope:
  allow:
  - src/**
  - tests/**
  deny:
  - _ctx/**
  - .env*
verify:
  commands:
  - rg -c "compute_segment_id|normalize_segment_id" src/ --type py | grep -v "deprecated\|# DEPRECATED"
  - rg -c "sha256.*path" src/ --type py | grep -v test
dod_id: DOD-DEFAULT
execution:
  engine: trifecta
  required_flow:
  - session.append:intent
  - ctx.sync
  - ctx.search
  - ctx.get
  - session.append:result
  segment: .
objective: 'Complete SSOT migration by removing all legacy segment_id functions from

  production code and add CI guard to prevent drift.

  '
started_at: '2026-02-15T20:06:27.208527+00:00'
commands:
- uv run pytest tests/unit/test_segment_resolver.py -v
deliverables:
- Inventory of all remaining compute_segment_id/normalize_segment_id uses
- Migrate all call sites to resolve_segment_ref()
- Remove deprecated wrappers or mark as internal-only
- Add CI grep guard to block new uses of legacy functions
- Smoke tests verify single namespace for sockets/caches/telemetry
diff_budget:
  max_files: 20
  max_loc: 500
stop_conditions:
  max_iterations: 3
  max_fail_verify: 2
