version: 1
id: WO-0024
epic_id: E-0002
title: Runtime Introspection for Invalid Options (Anti-Deriva)
priority: P1
status: running
owner: vscode
verified_at_sha: null
closed_at: null
scope:
  allow:
  - src/cli/invalid_option_handler.py
  - src/cli/introspection.py
  - src/domain/cli_models.py
  - src/infrastructure/telemetry.py
  - tests/unit/cli/test_invalid_option_handler.py
  - tests/unit/cli/test_introspection.py
  - tests/integration/test_cli_invalid_options.py
  - tests/integration/test_cli_telemetry.py
  - docs/reports/cli_runtime_introspection.md
  deny:
  - .env*
  - src/application/**
dod_id: DOD-DEFAULT
verify:
  commands:
  - uv run pytest tests/unit/cli/test_invalid_option_handler.py
  - uv run pytest tests/integration/test_cli_invalid_options.py
  - uv run pytest tests/unit/cli/test_introspection.py
  - uv run pytest tests/integration/test_cli_telemetry.py
  - uv run mypy src/cli/ --strict
  - uv run ruff check src/cli/
  - uv run ruff format src/cli/
governance:
  must:
  - "Use TDD: Write tests BEFORE implementation (RED \u2192 GREEN)"
  - Pure function only (no IO in domain)
  - Commit (no --no-verify)
  - One PR per phase or commits tagged by phase (phase1/..., phase2/...)
  - Run verify.sh before commit (no excuses)
x_objective: 'Replace static flag mappings with runtime Click/Typer introspection
  to

  provide deterministic, regression-proof invalid option handling with

  telemetry-backed KPIs.


  **Core Principle:** Single source of truth + automatic gates + telemetry evidence.

  No "I think...": everything comes from Click/Typer introspection and is validated

  with tests + verify.sh.

  '
x_items:
- 'Define DoD per item: 100% runtime flag discovery, handler only suggests real flags,
  telemetry emits events, regression tests cover ''add flag and it appears automatically'',
  verify.sh passes'
- 'Freeze scope: only ctx, ctx sync, ctx build, create (minimum with highest ROI)'
- 'Implement introspect_options(command) -> List[OptionSpec] extracting from Click:
  param.opts, param.secondary_opts, param.name, param.required, param.nargs, param.multiple,
  param.type'
- Implement valid_flags_for(argv/command_path) using real command tree, resolving
  current command (subcommands included), producing set of valid flags
- "Gate: if command cannot be resolved \u2192 fail-closed (no invented suggestions)"
- 'Rewrite invalid_option_handler to: parse invalid token, get valid_flags_for(command_actual),
  suggest by simple distance (prefix, levenshtein if exists in repo), NEVER suggest
  flags outside the set, if set is empty: output ''No suggestions available'' (fail-closed)'
- 'Gate: test that verifies ''no leaks'': no suggestion can be outside valid_flags'
- 'Emit JSONL events: help_used (command_path, argv_len, is_tty, platform), invalid_option
  (command_path, invalid_token, suggestions_count, had_match, platform)'
- 'Add aggregated counters (KPI): help_first_used (first time per session), invalid_option_count
  (per session)'
- 'Gate: unit tests for ''event emitted'' with mandatory minimum payload'
- 'Golden test: for each target command, snapshot of real flags (derived runtime)'
- "Regression: add dummy flag in test command \u2192 introspection detects it without\
  \ mapping changes"
- "Handler: input with typo \u2192 suggestions \u2286 valid flags"
- 'Gate: pytest -q passes + coverage of these modules'
- 'README snippet in invalid_option_handler.py: contract, invariants, examples, fail-closed'
- "Cross-platform: automatic ASCII fallback (detect Windows/CI/encoding \u2192 degrade\
  \ symbols)"
- 'Final gate: scripts/verify.sh WO-0024 generates report and PASS'
diff_budget:
  max_files: 10
  max_loc: 500
stop_conditions:
  max_iterations: 10
  max_fail_verify: 3
dependencies:
- WO-0022
x_phases:
- name: 'Phase 0: Contract and Scope'
  status: pending
  items:
  - Define DoD per item
  - Freeze scope to minimum ROI commands
- name: 'Phase 1: Runtime Introspection'
  status: pending
  items:
  - Implement introspect_options()
  - Implement valid_flags_for()
  - 'Gate: fail-closed on unresolved commands'
- name: 'Phase 2: Deterministic Handler'
  status: pending
  items:
  - Rewrite invalid_option_handler
  - 'Gate: no-leaks test'
- name: 'Phase 3: Telemetry'
  status: pending
  items:
  - Emit help_used events
  - Emit invalid_option events
  - Add KPI counters
  - 'Gate: event emission tests'
- name: 'Phase 4: Regression Tests'
  status: pending
  items:
  - Golden test for flag snapshots
  - Regression test for new flags
  - Handler suggestion subset test
  - 'Gate: pytest + coverage'
- name: 'Phase 5: Documentation and Closure'
  status: pending
  items:
  - README snippet in handler
  - Cross-platform ASCII fallback
  - 'Final gate: verify.sh PASS'
x_discipline_rules:
- Each change must have test or explicit reason why not applicable
- 'Do not touch anything outside scope (if ''would also improve X'' appears: create
  backlog, do not implement)'
- One PR per phase or commits tagged by phase (phase1/..., phase2/...)
- 'Before commit: run verify local (no excuses)'
x_expected_result: 'An agent that:

  - Discovers real flags (no invention)

  - Suggests only valid options

  - Leaves verifiable telemetry to demonstrate improvement


  If you want "solid line", this is: lanes + gates + single source of truth.

  '
started_at: '2026-02-10T08:51:56.722959+00:00'
branch: feat/wo-WO-0024
worktree: .worktrees/WO-0024
