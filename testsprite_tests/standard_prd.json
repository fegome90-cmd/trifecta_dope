{
  "meta": {
    "project": "Trifecta Generator (trifecta_dope)",
    "date": "2026-02-15",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "Trifecta is a CLI-first system that builds, validates, and serves small, audited context packs for code-focused agents. It provides deterministic context search/get, AST symbol extraction, telemetry, and segment scaffolding following a Clean Architecture.",
  "core_goals": [
    "Produce small, deterministic context packs (digest + index + chunks) that agents can consume on-demand.",
    "Expose a simple Typer CLI surface for building, validating, searching, and retrieving context with audit-grade evidence and fail-closed gates.",
    "Keep domain logic pure (no IO) and maintain strict layer separation (Domain → Application → Infrastructure).",
    "Provide telemetry and metrics with a pre-commit kill switch to avoid side-effects during tests.",
    "Support reproducible developer workflows (work orders, segment scaffolding, TDD-first development)."
  ],
  "features": [
    {
      "name": "Context Pack Management",
      "description": "Build, validate, and synchronize context packs for a segment so agents/tools can discover and fetch curated chunks deterministically.",
      "user_flows": [
        "trifecta ctx build --segment . -> Receive context_pack.json created -> trifecta ctx validate --segment . -> Receive Validation passed",
        "trifecta ctx build --segment . -> Receive Error with details (missing _ctx/ structure) -> trifecta ctx sync --segment . -> Receive Sync failed"
      ]
    },
    {
      "name": "Context Search & Retrieval",
      "description": "Search the context pack index for relevant chunk IDs and retrieve chunk content in excerpt or full modes for agent consumption.",
      "user_flows": [
        "trifecta ctx search --segment . --query \"Find documentation about telemetry event schema\" --limit 5 -> Receive Search results with chunk IDs -> trifecta ctx get --segment . --ids \"prime:abc123\" --mode excerpt -> Receive Chunk content in requested mode",
        "trifecta ctx search --segment . --query \"ambiguous natural language query\" --limit 5 -> Receive 0 search results with suggestion to refine query on stderr -> trifecta ctx get --segment . --ids \"nonexistent:id\" --mode excerpt -> Receive Error: Chunk not found"
      ]
    },
    {
      "name": "AST Parsing & Symbol Analysis",
      "description": "Parse source files with tree-sitter and extract symbol metadata for code-level discovery (modules, functions, classes).",
      "user_flows": [
        "trifecta ast symbols \"sym://python/mod/src.domain.result\" --segment . -> Receive Symbol list with metadata",
        "trifecta ast symbols \"sym://invalid/uri\" --segment . -> Receive Error: unable to resolve symbol path or parse source"
      ]
    },
    {
      "name": "Telemetry & Metrics",
      "description": "Collect CLI and feature usage events and produce telemetry reports and quick stats while supporting a kill-switch/redirection for pre-commit and test runs.",
      "user_flows": [
        "trifecta telemetry report -s . --last 30 --format json -> Receive Report in requested format",
        "TRIFECTA_NO_TELEMETRY=1 trifecta telemetry report -s . --last 30 -> Receive Report in requested format (no-side-effects) -> trifecta ctx stats --segment . -> Receive Stats summary"
      ]
    },
    {
      "name": "Segment Creation",
      "description": "Scaffold a new Trifecta segment with required templates and _ctx/ metadata so the segment is immediately usable by agents and CLI flows.",
      "user_flows": [
        "trifecta create --segment ./my-segment -> Receive Segment files created",
        "trifecta create --segment /protected/path -> Receive Creation failed"
      ]
    }
  ],
  "code_summary": {
    "version": "2",
    "type": "backend",
    "tech_stack": [
      "Python 3.12",
      "Typer CLI framework",
      "Pydantic for data validation",
      "tree-sitter for AST parsing",
      "JSON/YAML for configuration"
    ],
    "features": [
      {
        "name": "Context Pack Management",
        "description": "Build, validate, and manage context packs for code segments",
        "files": [
          "src/infrastructure/cli.py",
          "src/application/use_cases.py",
          "src/domain/models.py"
        ],
        "endpoints": [
          {
            "method": "CLI",
            "path": "trifecta ctx build",
            "description": "Build context pack for segment",
            "auth_required": false,
            "response_schema": {
              "0": "context_pack.json created",
              "1": "Error with details"
            }
          },
          {
            "method": "CLI",
            "path": "trifecta ctx validate",
            "description": "Validate context pack health",
            "auth_required": false,
            "response_schema": {
              "0": "Validation passed",
              "1": "Validation failed with errors"
            }
          },
          {
            "method": "CLI",
            "path": "trifecta ctx sync",
            "description": "Build + Validate macro",
            "auth_required": false,
            "response_schema": {
              "0": "Sync complete",
              "1": "Sync failed"
            }
          }
        ],
        "depends_on": [
          "File System Access",
          "Segment Configuration"
        ]
      },
      {
        "name": "Context Search & Retrieval",
        "description": "Search and retrieve code chunks from context packs",
        "files": [
          "src/application/search_get_usecases.py",
          "src/application/query_normalizer.py",
          "src/application/query_linter.py"
        ],
        "endpoints": [
          {
            "method": "CLI",
            "path": "trifecta ctx search",
            "description": "Search for relevant chunks",
            "auth_required": false,
            "response_schema": {
              "0": "Search results with chunk IDs"
            }
          },
          {
            "method": "CLI",
            "path": "trifecta ctx get",
            "description": "Retrieve full chunk content",
            "auth_required": false,
            "response_schema": {
              "0": "Chunk content in requested mode"
            }
          }
        ],
        "depends_on": [
          "Context Pack Management",
          "Query Processing Pipeline"
        ]
      },
      {
        "name": "AST Parsing & Symbol Analysis",
        "description": "Parse source code and extract symbols using tree-sitter",
        "files": [
          "src/infrastructure/cli_ast.py",
          "src/application/ast_parser.py",
          "src/domain/ast_models.py"
        ],
        "endpoints": [
          {
            "method": "CLI",
            "path": "trifecta ast symbols",
            "description": "Extract symbols from source files",
            "auth_required": false,
            "response_schema": {
              "0": "Symbol list with metadata"
            }
          }
        ],
        "depends_on": [
          "tree-sitter Python bindings"
        ]
      },
      {
        "name": "Telemetry & Metrics",
        "description": "Track usage metrics and generate reports",
        "files": [
          "src/infrastructure/telemetry.py",
          "src/application/telemetry_reports.py",
          "src/application/telemetry_charts.py"
        ],
        "endpoints": [
          {
            "method": "CLI",
            "path": "trifecta telemetry report",
            "description": "Generate telemetry report",
            "auth_required": false,
            "response_schema": {
              "0": "Report in requested format"
            }
          },
          {
            "method": "CLI",
            "path": "trifecta ctx stats",
            "description": "Show telemetry statistics",
            "auth_required": false,
            "response_schema": {
              "0": "Stats summary"
            }
          }
        ],
        "depends_on": [
          "Context Pack Management"
        ]
      },
      {
        "name": "Segment Creation",
        "description": "Scaffold new Trifecta segments with templates",
        "files": [
          "src/infrastructure/cli.py",
          "src/infrastructure/templates.py",
          "src/domain/models.py"
        ],
        "endpoints": [
          {
            "method": "CLI",
            "path": "trifecta create",
            "description": "Create new segment scaffold",
            "auth_required": false,
            "response_schema": {
              "0": "Segment files created",
              "1": "Creation failed"
            }
          }
        ],
        "depends_on": [
          "Template Rendering"
        ]
      }
    ],
    "known_limitations": [
      {
        "issue": "CLI tool, not web API - TestSprite web testing not applicable",
        "location": "Project architecture",
        "impact": "Cannot use TestSprite HTTP endpoint testing"
      },
      {
        "issue": "Requires segment initialization before most commands work",
        "location": "src/infrastructure/cli.py",
        "impact": "Commands fail without proper _ctx/ directory structure"
      }
    ]
  }
}
