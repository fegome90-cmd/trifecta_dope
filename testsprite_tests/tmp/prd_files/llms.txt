# Trifecta Dope - LLM Reference

> Quick reference for agents. See SKILL.md for full documentation.

---

## L0: Quick Reference (Start Here)

### Core Commands
```
trifecta ctx sync --segment .         # Build + validate context
trifecta ctx search --segment . --query "instruction" --limit 6
trifecta ctx get --segment . --ids "..." --mode excerpt --budget-token-est 900
trifecta ctx validate --segment .
```

### Required Reading Order
1. skill.md (project rules)
2. _ctx/agent_trifecta_dope.md (stack, tech)
3. _ctx/session_trifecta_dope.md (current work)
4. _ctx/prime_trifecta_dope.md (prioritized reading)

### Rules That Must Not Be Violated
- No absolute paths in docs (use relative)
- No silent fallback if ctx validate fails
- No IO or async in domain layer
- Log session intent in _ctx/session_trifecta_dope.md

---

## L1: Workflows

### Context Pack Cycle (Always Use)
```
1. trifecta session append --segment . --summary "intent"
2. trifecta ctx sync --segment .
3. trifecta ctx search --segment . --query "instruction" --limit 6
4. trifecta ctx get --segment . --ids "id1,id2" --mode excerpt
5. trifecta session append --segment . --summary "result"
```

### Work Order Workflow
```
# Take WO
uv run python scripts/ctx_wo_take.py WO-XXXX

# Navigate to worktree
cd .worktrees/WO-XXXX

# Work + sync
trifecta ctx sync --segment .
# ... work ...
trifecta ctx validate --segment .

# Finish WO
uv run python scripts/ctx_wo_finish.py WO-XXXX
```

### Stale Fail-Closed Protocol
If `stale_detected=true` or validation fails:
```
1. Stop immediately
2. Run: trifecta ctx sync --segment .
3. Run: trifecta ctx validate --segment .
4. Log: "Stale: true -> sync+validate executed"
5. Continue only if PASS
```

---

## L2: Common Errors + Fixes

### SEGMENT_NOT_INITIALIZED
**Cause**: Context pack not built
**Fix**: `trifecta ctx sync --segment .`

### stale_detected=true
**Cause**: Context pack outdated
**Fix**: Run sync + validate (see Stale Protocol above)

### ModuleNotFoundError: src
**Cause**: Running python without uv
**Fix**: Use `uv run python ...` or activate venv

### Zero hits on ctx search
**Cause**: Query too specific or not in index
**Fix**: 
- Use instruction-based queries, not keywords
- Add relevant docs to _ctx/prime_*.md
- Rebuild: trifecta ctx sync --segment .

### Validation fails
**Cause**: Structure violated or files missing
**Fix**: 
- Do NOT proceed without fixing
- Check: _ctx/ directory structure
- Run: trifecta ctx validate --segment . --verbose

---

## Project Structure

```
src/domain/          # Pure business logic (no IO)
src/application/     # Use cases, orchestration
src/infrastructure/  # Adapters, CLI, templates
skills/              # Agent skills
docs/                # Contracts, ADRs, guides
_ctx/                # Context pack, jobs, telemetry
_ctx/backlog/        # Work order backlog
_ctx/jobs/           # pending/, running/, done/
_ctx/telemetry/      # Event logs
```

---

## Documentation Skills

### Validation
```bash
# Validate doc patterns
bash skills/documentation/resources/verify_documentation.sh

# With health score
bash skills/documentation/resources/verify_documentation.sh --json
```

### Templates
- skills/documentation/resources/CLAUDE_md_template.md
- skills/documentation/resources/agents_md_template.md
- skills/documentation/resources/skill_md_template.md

### Guides
- skills/documentation/resources/guides/QUICKSTART.md (5 min)
- skills/documentation/resources/guides/ADVANCED.md (30 min)

---

## Testing Gates

```
make test-unit           # Domain + application tests
make test-integration    # Use cases with real adapters
make test-acceptance     # CLI black-box (gate: -m "not slow")
make gate-all           # Full validation suite
```

---

## Key Files

| File | Purpose |
|------|---------|
| README.md | Project overview |
| CLAUDE.md | Agent onboarding (read FIRST) |
| skill.md | Project-specific rules |
| _ctx/agent_trifecta_dope.md | Stack, dependencies, patterns |
| _ctx/prime_trifecta_dope.md | Prioritized reading list |
| _ctx/session_trifecta_dope.md | Session log, handoffs |

---

## Telemetry

```bash
trifecta telemetry report -s . --last 30
trifecta telemetry chart -s . --type hits
```

---

> For full documentation, see: skills/documentation/SKILL.md
