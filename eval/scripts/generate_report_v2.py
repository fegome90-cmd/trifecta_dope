import json
import os
import sys


def main():
    summary_path = "_ctx/metrics/field_exercises_v2_summary.json"
    results_path = "_ctx/metrics/field_exercises_v2_ab.json"

    with open(summary_path) as f:
        data = json.load(f)

    metrics = data["metrics"]
    buckets = metrics["buckets"]
    gates = data["gate_results"]["gates"]
    overall_pass = data["gate_results"]["overall_pass"]
    deltas = metrics["causal_deltas"]

    # Get git SHA
    # sha = os.popen('git rev-parse HEAD').read().strip()
    # Or just placeholder if running pre-commit

    report = f"""# Field Exercises v2 - Hard Query A/B Results

**Date**: 2026-01-06  
**Dataset**: 30 hard queries (vague_1token, spanish_natural, navigation_2hop)  
**Method**: Live Index Execution (CLI)  
**Source**: `{summary_path}`  
**Evidence**: `_ctx/logs/wo0011_live/`

---

## Executive Summary

Field Exercises v2 tested system resilience with intentionally difficult queries on a LIVE index.

**Overall Verdict**: {"✅ **ALL GATES PASSED**" if overall_pass else "❌ **FAIL**"}

## Metrics by Bucket

| Bucket | Queries | Anchor Usage (ON) | Zero-Hit Rate (ON) | Median Hits (ON) |
|--------|---------|-------------------|--------------------|------------------|
"""

    for name, b in buckets.items():
        pass_mark = (
            "✅ " if b["zero_hit_rate"] <= 20 else "⚠️ "
        )  # Simple visual aid, real gate is on vague only
        report += f"| {name} | {b['total_queries']} | {b['anchor_usage_rate']}% | {b['zero_hit_rate']}% | {b['median_hits_on']} |\n"

    report += f"""
---

## Gate Results

### Gate 1: Vague Anchor Usage ≥ 30%
**Status**: {"✅ PASS" if gates["vague_anchor_usage_30pct"]["pass"] else "❌ FAIL"}  
**Value**: {gates["vague_anchor_usage_30pct"]["value"]}%  
**Threshold**: ≥ 30%

### Gate 2: Vague Zero-Hit Rate ≤ 20%
**Status**: {"✅ PASS" if gates["vague_zero_hit_20pct"]["pass"] else "❌ FAIL"}  
**Value**: {gates["vague_zero_hit_20pct"]["value"]}%  
**Threshold**: ≤ 20%

### Gate 3: Expanded Queries Have Positive Delta
**Status**: {"✅ PASS" if gates["expanded_positive_delta"]["pass"] else "❌ FAIL"}  
**Median Δ**: +{gates["expanded_positive_delta"]["value"]}  
**Threshold**: > 0

---

## Causal Analysis

| Group | Count | Median Δ | Notes |
|-------|-------|----------|-------|
| Expanded=true | {deltas["expanded_true"]["count"]} | +{deltas["expanded_true"]["median_delta"]} | Linter active |
| Expanded=false | {deltas["expanded_false"]["count"]} | +{deltas["expanded_false"]["median_delta"]} | Baseline/Fallback |

---

## Detailed Observations (Live Run)

1. **Vague Queries**: {buckets["vague_1token"]["anchor_usage_rate"]}% expansion rate. Median hits: {buckets["vague_1token"]["median_hits_on"]}.
2. **Spanish Queries**: {buckets["spanish_natural"]["zero_hit_rate"]}% zero-hit rate. Median hits: {buckets["spanish_natural"]["median_hits_on"]}.
   *(Note: Previous mocks predicted high failure, but live index performed well)*.
3. **Navigation Queries**: {buckets["navigation_2hop"]["anchor_usage_rate"]}% expansion. Median hits: {buckets["navigation_2hop"]["median_hits_on"]}.

---

**Generated by**: `eval/scripts/generate_report_v2.py`
"""

    with open("docs/reports/field_exercises_v2_results.md", "w") as f:
        f.write(report)
    print("✅ Report generated at docs/reports/field_exercises_v2_results.md")


if __name__ == "__main__":
    main()
