import json
import os
import sys
from pathlib import Path


def main():
    repo_root = Path(__file__).resolve().parents[3]
    summary_path = (
        repo_root / "trifecta_dope" / "_ctx" / "metrics" / "field_exercises_v2_summary.json"
    )

    with open(summary_path) as f:
        data = json.load(f)

    metrics = data["metrics"]
    buckets = metrics["buckets"]
    gates = data["gate_results"]["gates"]
    overall_pass = data["gate_results"]["overall_pass"]
    deltas = metrics["causal_deltas"]

    # 1. Get Evidence Metadata
    sha = os.popen("git rev-parse HEAD").read().strip()
    try:
        last_run_path = repo_root / "trifecta_dope" / "_ctx" / "telemetry" / "last_run.json"
        with open(last_run_path) as f:
            last_run = json.load(f)
            run_id = last_run.get("run_id", "unknown")
    except:
        run_id = "unknown (telemetry missing)"

    # 2. Consistency Checks (Gate v2.1)
    # Verify zero_hit_rate calculation
    for name, b in buckets.items():
        calc_zero = round((b["zero_hit_count"] / b["total_queries"]) * 100, 1)
        if calc_zero != b["zero_hit_rate"]:
            raise ValueError(
                f"Integrity Fail: Bucket {name} zero_hit_rate mismatch ({calc_zero}% vs {b['zero_hit_rate']}%)"
            )

        # Verify median consistency (basic bounds check)
        if b["zero_hit_count"] == b["total_queries"] and b["median_hits_on"] > 0:
            raise ValueError(
                f"Integrity Fail: Bucket {name} has 100% zero-hits but positive median ({b['median_hits_on']})"
            )

    # 3. Generate Report
    report = f"""# Field Exercises v2.1 - Hard Query A/B Results (Audit Grade)

## Evidence Header
- **SHA**: `{sha}`
- **Run ID**: `{run_id}`
- **Date**: 2026-01-06
- **Method**: Live Index Execution (CLI)
- **Dataset**: `field_exercises_v2.yaml` (v2.1, 33 queries)
- **Source**: `_ctx/metrics/field_exercises_v2_summary.json`
- **Logs**: `_ctx/logs/wo0011_live/`

---

## Executive Summary

Field Exercises v2.1 validates system resilience with 33 hard queries on a LIVE index.
Includes pure Spanish queries to verify multilingual support.

**Overall Verdict**: {"✅ **ALL GATES PASSED**" if overall_pass else "❌ **FAIL**"}

## Metrics by Bucket

| Bucket | Queries | Anchor Usage (ON) | Zero-Hit Rate (ON) | Median Hits (ON) |
|--------|---------|-------------------|--------------------|------------------|
"""

    for name, b in buckets.items():
        report += f"| {name} | {b['total_queries']} | {b['anchor_usage_rate']}% | {b['zero_hit_rate']}% | {b['median_hits_on']} |\n"

    report += f"""
---

## Gate Results

### Gate 1: Vague Anchor Usage ≥ 30%
**Status**: {"✅ PASS" if gates["vague_anchor_usage_30pct"]["pass"] else "❌ FAIL"}  
**Value**: {gates["vague_anchor_usage_30pct"]["value"]}%  
**Threshold**: ≥ 30%

### Gate 2: Vague Zero-Hit Rate ≤ 20%
**Status**: {"✅ PASS" if gates["vague_zero_hit_20pct"]["pass"] else "❌ FAIL"}  
**Value**: {gates["vague_zero_hit_20pct"]["value"]}%  
**Threshold**: ≤ 20%

### Gate 3: Expanded Queries Have Positive Delta
**Status**: {"✅ PASS" if gates["expanded_positive_delta"]["pass"] else "❌ FAIL"}  
**Median Δ**: +{gates["expanded_positive_delta"]["value"]}  
**Threshold**: > 0

---

## Causal Analysis

| Group | Count | Median Δ | Notes |
|-------|-------|----------|-------|
| Expanded=true | {deltas["expanded_true"]["count"]} | +{deltas["expanded_true"]["median_delta"]} | Linter active |
| Expanded=false | {deltas["expanded_false"]["count"]} | +{deltas["expanded_false"]["median_delta"]} | Baseline/Fallback |

---

## Detailed Observations (Live Run)

1. **Vague Queries**: {buckets["vague_1token"]["anchor_usage_rate"]}% expansion. Median hits: {buckets["vague_1token"]["median_hits_on"]}.
2. **Spanish Queries**: {buckets["spanish_natural"]["zero_hit_rate"]}% zero-hit rate. Median hits: {buckets["spanish_natural"]["median_hits_on"]}.
3. **Navigation Queries**: {buckets["navigation_2hop"]["anchor_usage_rate"]}% expansion. Median hits: {buckets["navigation_2hop"]["median_hits_on"]}.

---

**Generated by**: `eval/scripts/generate_report_v2.py`
"""

    output_path = repo_root / "trifecta_dope" / "docs" / "reports" / "field_exercises_v2_results.md"
    with open(output_path, "w") as f:
        f.write(report)
    print(f"✅ Report generated (Audit Integrity Verified)")


if __name__ == "__main__":
    main()
