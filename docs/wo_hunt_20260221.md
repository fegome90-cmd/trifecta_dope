# WO Hunt 20260221 - Silent Transaction Failures

> **Date**: 2026-02-21
> **Hunt Mode**: Evidence-First Systematic Leak Detection
> **Status**: ✅ FIXED - Batch Fixes Applied

---

## Snapshot

| Metric | Value |
|--------|-------|
| **Run Timestamp** | 2026-02-21T17:48:00+00:00 |
| **Git HEAD** | See `data/wo_hunt_20260221/head.txt` |
| **Worktrees** | See `data/wo_hunt_20260221/worktrees_porcelain.txt` |

---

## Executive Summary

**WO-0015 Pattern Confirmed**: We found **1 case** of "FAIL but still RUNNING" (WO-0057), which is the exact same pattern as WO-0015. Additionally, we found **1 abandoned WO** (WO-0055) that is stuck in running state with no verdict.

**Total Issues Found**:
- **Class A (FAIL but RUNNING)**: 1 case (WO-0057) ✅ FIXED
- **Class B (Stale Locks)**: 2 cases (WO-0055, WO-0057) ✅ FIXED
- **Class C (Worktree Zombies)**: 0 cases ✅
- **Class D (Duplicate YAML)**: 3 cases (WO-0008, WO-0009, WO-0010) - P2, historical

---

## Remediation Applied

### Phase 1: Immediate Remediation ✅

#### WO-0057 (FAIL but RUNNING)

**Before**:
```
_ctx/jobs/running/WO-0057.yaml    ← EXISTS (should be in failed/)
_ctx/jobs/running/WO-0057.lock    ← STALE (74.5h)
_ctx/logs/WO-0057/verdict.json    ← EXISTS with FAIL status
```

**After**:
```
_ctx/jobs/failed/WO-0057.yaml     ← MOVED
_ctx/jobs/running/WO-0057.lock    ← REMOVED
_ctx/logs/WO-0057/verdict.json    ← PRESERVED
```

**Evidence**: `data/wo_repairs/WO-0057/before/` and `data/wo_repairs/WO-0057/after/`

#### WO-0055 (Abandoned)

**Before**:
```
_ctx/jobs/running/WO-0055.yaml    ← EXISTS (status: running)
_ctx/jobs/running/WO-0055.lock    ← STALE (98.2h)
_ctx/logs/WO-0055/                ← NO verdict.json
```

**After**:
```
_ctx/jobs/failed/WO-0055.yaml     ← MOVED
_ctx/jobs/running/WO-0055.lock    ← REMOVED
```

**Evidence**: `data/wo_repairs/WO-0055/before/` and `data/wo_repairs/WO-0055/after/`

---

### Phase 2: Structural Fix ✅

#### Changes Made

1. **[`scripts/wo_verify.sh`](scripts/wo_verify.sh)**: Added `transition_to_failed()` function
   - Moves YAML from `running/` to `failed/` on any failure
   - Removes lock file
   - Called on `scope_lint` failure, `load_commands` failure, and command execution failure

2. **[`scripts/wo_audit.py`](scripts/wo_audit.py)**: Added `fail_but_running` detection
   - New finding code for detecting FAIL verdict but YAML still in running/
   - Severity: P0
   - Enables early detection of this pattern

#### Tests Added

1. **[`tests/unit/test_scope_lint_failure_transition.py`](tests/unit/test_scope_lint_failure_transition.py)**:
   - Verifies that `scope_lint` failure triggers transition to `failed/`
   - Verifies lock removal

2. **[`tests/unit/test_wo_audit_fail_but_running.py`](tests/unit/test_wo_audit_fail_but_running.py)**:
   - Verifies auditor detects FAIL but RUNNING pattern
   - Verifies no false positives when WO is properly in `failed/`

---

## Verification

```bash
# Run auditor
uv run python scripts/wo_audit.py --out /tmp/wo_audit_final.json

# Run tests
uv run pytest tests/unit/test_scope_lint_failure_transition.py -v
uv run pytest tests/unit/test_wo_audit_fail_but_running.py -v
uv run pytest tests/unit/test_ctx_verify_run.py -v
```

**Results**:
- Auditor: P0=0, P1=2 (zombie worktrees - expected), P2=3 (duplicate YAMLs - historical)
- All tests: PASS

---

## Class of Bug Eliminated

The "FAIL but RUNNING" pattern (WO-0015/WO-0057) is now:

1. **Detected**: The auditor will flag any new occurrences
2. **Prevented**: The `wo_verify.sh` script now transitions to `failed/` on any failure
3. **Tested**: Unit tests verify the fix works

---

## Remaining Items (P2)

- **Zombie worktrees**: WO-0055 and WO-0057 worktrees still exist (dirty). GC policy needed.
- **Duplicate YAMLs**: WO-0008, WO-0009, WO-0010 have historical duplicates in `done/`

---

## Files Changed

| File | Change |
|------|--------|
| `scripts/wo_verify.sh` | Added `transition_to_failed()` function |
| `scripts/wo_audit.py` | Added `fail_but_running` detection |
| `tests/unit/test_scope_lint_failure_transition.py` | NEW - Tests for structural fix |
| `tests/unit/test_wo_audit_fail_but_running.py` | NEW - Tests for auditor detection |
| `_ctx/jobs/failed/WO-0057.yaml` | MOVED from running/ |
| `_ctx/jobs/failed/WO-0055.yaml` | MOVED from running/ |

---

## Conclusion

The hunt confirmed that **WO-0015 was NOT isolated** - we found another instance (WO-0057) of the exact same pattern. This was a systemic bug in the failure path handling.

**Status**: ✅ **FIXED**
- Immediate remediation applied (WO-0057, WO-0055 moved to failed/)
- Structural fix implemented (transactional cleanup in `wo_verify.sh`)
- Tests added to prevent regression
- Auditor updated to detect future occurrences
